<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XRPL Checkbook | XRPMan Edition</title>
    <link rel="icon" href="data:,">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xrpl@2.14.0/build/xrpl-latest-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* APP SHELL SETUP */
        html, body, #root {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
            background-color: #000000;
            color: #39ff14;
            font-family: 'Rajdhani', sans-serif;
            background-image: radial-gradient(circle at center, #0a1f0a 0%, #000000 70%);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .font-mono { font-family: 'Share Tech Mono', monospace; }

        /* UI ELEMENTS */
        .hud-panel {
            background: rgba(0, 20, 0, 0.95);
            border: 1px solid #39ff14;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.1);
        }
        
        input, select, textarea {
            background: #050505;
            border: 1px solid #1a5c0a;
            color: #39ff14;
            outline: none;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #39ff14;
            box-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
        }

        .btn-action {
            background: #000;
            border: 1px solid #39ff14;
            color: #39ff14;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.1s;
        }
        .btn-action:active { transform: scale(0.98); }
        .btn-action:disabled { border-color: #555; color: #555; cursor: not-allowed; }

        /* SPINNER (REACTOR CORE) */
        .reactor-loader {
            width: 50px; height: 50px;
            border: 4px solid rgba(57, 255, 20, 0.1);
            border-left-color: #39ff14;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* TOAST ANIMATIONS */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* ANIMATIONS */
        .glow-pulse { animation: glowPulse 2s infinite; }
        @keyframes glowPulse {
            0% { text-shadow: 0 0 5px #39ff14; opacity: 0.8; }
            50% { text-shadow: 0 0 15px #39ff14; opacity: 1; }
            100% { text-shadow: 0 0 5px #39ff14; opacity: 0.8; }
        }

        /* TEXT NEON PULSE */
        .text-neon-pulse { animation: textNeonPulse 1.5s infinite alternate; }
        @keyframes textNeonPulse {
            0% { text-shadow: 0 0 10px #39ff14, 0 0 20px #39ff14; opacity: 0.9; transform: scale(1); }
            100% { text-shadow: 0 0 20px #39ff14, 0 0 30px #39ff14, 0 0 40px #39ff14; opacity: 1; transform: scale(1.02); }
        }

        /* ENERGY FLICKER */
        .energy-flicker { animation: energyFlicker 3s infinite; }
        @keyframes energyFlicker {
            0%, 100% { opacity: 0.7; text-shadow: 0 0 5px #39ff14; }
            50% { opacity: 1; text-shadow: 0 0 15px #39ff14, 0 0 20px #39ff14; }
            52% { opacity: 0.8; text-shadow: 0 0 5px #39ff14; }
            54% { opacity: 1; text-shadow: 0 0 15px #39ff14; }
        }

        /* CUSTOM SCROLLBAR */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #000; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #1a5c0a; }

        /* TAB STYLING */
        .tab-btn {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.7rem;
            text-transform: uppercase;
            border-top: 2px solid transparent;
            opacity: 0.6;
            transition: all 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .tab-btn.active {
            border-top-color: #39ff14;
            color: #39ff14;
            background: rgba(57, 255, 20, 0.05);
            opacity: 1;
            text-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
        }

        /* BACKGROUND */
        .floating-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
            overflow: hidden;
        }
        .xrp-logo {
            position: absolute; opacity: 0.15; color: #39ff14;
            animation: floatMove linear infinite;
        }
        @keyframes floatMove {
            0% { transform: translateY(110vh) rotate(0deg) scale(0.8); opacity: 0; }
            20% { opacity: 0.15; }
            80% { opacity: 0.15; }
            100% { transform: translateY(-10vh) rotate(360deg) scale(1.2); opacity: 0; }
        }

        /* MODAL OVERLAY */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            z-index: 100;
            display: flex; justify-content: center; items-center;
            animation: fadeIn 0.2s ease-out;
            padding: 10px; /* Safe area padding */
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* PREVIEW CARD STYLES */
        .preview-row { display: flex; justify-content: space-between; border-bottom: 1px solid #1a5c0a; padding: 8px 0; font-family: 'Share Tech Mono', monospace; font-size: 11px; }
        .preview-row:last-child { border-bottom: none; }
        .preview-label { color: #888; text-transform: uppercase; }
        .preview-val { color: #fff; font-weight: bold; }
        .risk-warning { background: rgba(255, 0, 0, 0.1); border: 1px solid red; color: red; padding: 10px; margin-top: 10px; font-size: 10px; text-align: center; animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% { opacity: 0.8; } 50% { opacity: 1; box-shadow: 0 0 10px red; } 100% { opacity: 0.8; } }

        /* INTERACTIVE TOUR STYLES */
        .tour-dimmer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            pointer-events: auto; /* Blocks clicks everywhere else */
        }
        /* The target element gets this class added dynamically */
        .tour-highlighted-element {
            position: relative !important;
            z-index: 2005 !important;
            box-shadow: 0 0 30px #39ff14, 0 0 10px #39ff14 inset !important;
            border: 2px solid #39ff14 !important;
            background-color: black !important;
            color: #39ff14 !important;
            pointer-events: auto !important; /* Allows clicking THIS element */
            animation: pulseHigh 1s infinite alternate;
        }
        @keyframes pulseHigh {
            from { box-shadow: 0 0 20px #39ff14; transform: scale(1); }
            to { box-shadow: 0 0 40px #39ff14; transform: scale(1.02); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.3s ease-in-out; }

        .tour-tooltip-box {
            position: absolute;
            background: #000;
            border: 1px solid #39ff14;
            padding: 15px;
            width: 250px;
            z-index: 2010;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            pointer-events: auto; /* Ensures tooltip buttons are clickable */
            transition: all 0.3s ease-out;
        }
        .tour-tooltip-box.bottom { margin-top: 20px; }
        .tour-tooltip-box.top { margin-bottom: 20px; transform: translateY(-100%); }
        
        /* INTRO VIDEO OVERLAY */
        .intro-overlay-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* COMPACT KEYBOARD STYLES */
        .vk-container {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: #050505; border-top: 1px solid #39ff14; 
            z-index: 5000; padding: 4px; padding-bottom: 12px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
            transition: transform 0.2s ease-in-out;
        }
        .vk-row { display: flex; justify-content: center; gap: 3px; margin-bottom: 4px; }
        .vk-key {
            background: #1a1a1a; color: #fff; border: 1px solid #333;
            border-radius: 4px; 
            height: 38px; /* Reduced from 45px */
            min-width: 28px;
            display: flex; align-items: center; justify-content: center;
            font-family: monospace; 
            font-size: 14px; /* Reduced from 16px */
            font-weight: bold;
            flex: 1; max-width: 45px; cursor: pointer;
            box-shadow: 0 1px 0 #000;
        }
        .vk-key:active { background: #39ff14; color: black; transform: translateY(1px); box-shadow: none; }
        .vk-key.wide { flex: 1.5; max-width: 60px; font-size: 11px; }
        .vk-key.space { flex: 4; max-width: 180px; }
        .vk-key.special { background: #111; color: #888; }
        .vk-toolbar { display: flex; justify-content: space-between; padding: 4px 10px; border-bottom: 1px solid #1a1a1a; margin-bottom: 6px; }

        .custom-cursor {
            display: inline-block; width: 8px; height: 1em; background: #39ff14;
            animation: blink 1s step-end infinite; vertical-align: bottom; margin-left: 2px;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        // --- CONFIGURATION ---
        const SERVICE_WALLET = "r9nepSD5tvQUCA4qQAJJDAoBB3j1gf4ibL";
        const SERVICE_FEE = "0.00001"; 
        const HIGH_VALUE_THRESHOLD = 100; // XRP
        const TOUR_KEY = "xrpl_interactive_tour_v7_sim_fixed"; 
        const INTERNAL_INTRO_KEY = "xrpl_internal_intro_v5"; 
        const SPLASH_KEY = "xrpl_splash_seen_v2"; 
        
        const INTERNAL_VIDEO_URL = "https://ipfs.io/ipfs/QmYYDVbVMQZuVFpApWva8ujFNiPLBfa9RkCJX9wDmktgkt";
        const SPLASH_VIDEO_URL = "https://ipfs.filebase.io/ipfs/QmQDR8ruUVNy2aHdmLzq3d4Y5GASuW7wUjysTtC3WgwAaK";

        // MOCK DATA FOR SIMULATION
        const DEMO_ADDR = "rDemoAddress...XRP";
        const DEMO_AMT = "50";

        const TOUR_STEPS = [
            { 
                selector: "#nav-write", 
                text: "Welcome, Pilot. Let's learn how to fly. The WRITE tab is your command center for creating checks and payments.", 
                tab: "WRITE",
                action: "click"
            },
            { 
                selector: "#mode-switch", 
                text: "STEP 1: Choose your flight path. 'CHECKBOOK' sends deferred checks (receiver must cash). 'DIRECT SEND' is instant transfer.", 
                tab: "WRITE",
                action: "click"
            },
            { 
                selector: "#currency-select", 
                text: "STEP 2: Select payload. Use this dropdown to switch between standard XRP and other Assets (IOUs/Tokens).", 
                tab: "WRITE",
                action: "click"
            },
            { 
                selector: "#action-btn", 
                text: "STEP 3: Simulation Mode. I've auto-filled a test payment for you. Tap 'SIMULATE SEND' to see what happens.", 
                tab: "WRITE",
                action: "click",
                isSimulation: true // Trigger mock behavior
            },
            { 
                selector: "#nav-manage", 
                text: "Excellent. Now check MANAGE. This is your Outbox. If you send a Check, it lives here until cashed. You can VOID it to reclaim funds.", 
                tab: "MANAGE",
                action: "switch"
            },
            { 
                selector: "#nav-inbox", 
                text: "Check INBOX. This is your Landing Zone. If someone sends you a Check, it appears here. You MUST click 'CASH' to deposit it.", 
                tab: "INBOX",
                action: "switch" 
            },
            {
                selector: "#nav-logs",
                text: "Audit Trail. The LOGS tab connects directly to the XRP Ledger. Tap any transaction here to verify it on XRPScan (External).",
                tab: "LOGS",
                action: "switch"
            },
            { 
                selector: "#nav-wallet", 
                text: "Finally, IDENTITY. Here is your Address and Trustlines. You need Trustlines to receive Tokens.", 
                tab: "WALLET",
                action: "switch"
            },
            {
                selector: "#help-trigger",
                text: "Training Complete. If you ever need to run this simulation again, just tap this ? icon.",
                tab: "WALLET",
                action: "click"
            }
        ];

        // --- COMPONENTS: VIRTUAL KEYBOARD ---
        const VirtualKeyboard = ({ onChar, onBackspace, onClose, visible }) => {
            const [caps, setCaps] = useState(false);
            
            if (!visible) return null;

            const handleTouch = (char) => {
                if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(20);
                onChar(caps ? char.toUpperCase() : char);
            };

            const handlePaste = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if(text) onChar(text);
                } catch(e) {
                    alert("Clipboard permission needed to paste.");
                }
            };

            const row1 = ['1','2','3','4','5','6','7','8','9','0'];
            const row2 = ['q','w','e','r','t','y','u','i','o','p'];
            const row3 = ['a','s','d','f','g','h','j','k','l'];
            const row4 = ['z','x','c','v','b','n','m'];

            return (
                <div className="vk-container animate-slideUp">
                    <div className="vk-toolbar">
                        <span className="text-xs text-[#39ff14] font-mono animate-pulse">SECURE INPUT ACTIVE</span>
                        <div className="flex gap-4">
                            <button onClick={handlePaste} className="text-xs text-gray-400 hover:text-white"><i className="fas fa-paste"></i> PASTE</button>
                            <button onClick={onClose} className="text-xs text-red-500 font-bold">HIDE ▼</button>
                        </div>
                    </div>
                    
                    <div className="vk-row">
                        {row1.map(k => <button key={k} className="vk-key" onClick={()=>handleTouch(k)}>{k}</button>)}
                    </div>
                    <div className="vk-row">
                        {row2.map(k => <button key={k} className="vk-key" onClick={()=>handleTouch(k)}>{k}</button>)}
                    </div>
                    <div className="vk-row px-4">
                        {row3.map(k => <button key={k} className="vk-key" onClick={()=>handleTouch(k)}>{k}</button>)}
                    </div>
                    <div className="vk-row">
                        <button className={`vk-key wide special ${caps ? 'bg-[#39ff14] text-black' : ''}`} onClick={()=>setCaps(!caps)}>CAPS</button>
                        {row4.map(k => <button key={k} className="vk-key" onClick={()=>handleTouch(k)}>{k}</button>)}
                        <button className="vk-key wide special" onClick={onBackspace}>⌫</button>
                    </div>
                    <div className="vk-row">
                        <button className="vk-key space" onClick={()=>handleTouch(' ')}>SPACE</button>
                        <button className="vk-key wide special" onClick={onClose}>DONE</button>
                    </div>
                </div>
            );
        };

        // --- COMPONENTS: QR CODE ---
        const QRCodeCanvas = ({ value, size = 150 }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current && window.QRious) {
                    new QRious({
                        element: canvasRef.current,
                        value: value,
                        size: size,
                        background: 'transparent',
                        foreground: '#39ff14' // Neon Green
                    });
                }
            }, [value, size]);
            return <canvas ref={canvasRef} className="border border-[#1a5c0a] bg-black/50 p-2" />;
        };

        // --- COMPONENTS: TOAST ---
        const ToastContainer = ({ toasts, removeToast }) => {
            return (
                <div className="fixed top-20 right-4 z-[2000] flex flex-col gap-2 pointer-events-none">
                    {toasts.map(toast => (
                        <div key={toast.id} className={`toast-enter pointer-events-auto min-w-[200px] bg-black border-l-4 ${toast.type === 'error' ? 'border-red-500' : 'border-[#39ff14]'} p-3 shadow-[0_0_15px_rgba(0,0,0,0.9)] flex items-center justify-between border border-gray-800`}>
                            <div className="mr-4">
                                <div className={`text-[10px] font-bold ${toast.type === 'error' ? 'text-red-500' : 'text-[#39ff14]'} uppercase`}>{toast.type}</div>
                                <div className="text-xs text-white font-mono">{toast.msg}</div>
                            </div>
                            <button onClick={() => removeToast(toast.id)} className="text-gray-500 hover:text-white text-lg">×</button>
                        </div>
                    ))}
                </div>
            );
        };

        // --- COMPONENTS: LOADING SPINNER ---
        const GlobalSpinner = () => (
            <div className="fixed top-0 left-0 w-full h-full bg-black/80 backdrop-blur-sm z-[2000] flex flex-col items-center justify-center">
                <div className="reactor-loader mb-4"></div>
                <div className="text-[#39ff14] font-mono text-xs animate-pulse">PROCESSING LEDGER...</div>
            </div>
        );

        // --- COMPONENTS: TOKEN AVATAR ---
        const TokenIcon = ({ issuer, size=24 }) => {
            const [error, setError] = useState(false);
            const url = `https://xumm.app/avatar/${issuer}_200`;
            
            if (error || !issuer) {
                return <div className={`bg-[#1a5c0a] rounded-full border border-[#39ff14] flex items-center justify-center font-bold text-[#39ff14] text-[8px]`} style={{width: size, height: size}}>?</div>;
            }
            return (
                <img 
                    src={url} 
                    onError={() => setError(true)} 
                    className="rounded-full border border-[#39ff14] bg-black object-cover" 
                    style={{width: size, height: size}} 
                    alt="Token"
                />
            );
        };

        /* --- AUDIO SYSTEM --- */
        const useSound = () => {
            const audioCtx = useRef(null);
            const initAudio = () => {
                if (!audioCtx.current) audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.current.state === 'suspended') audioCtx.current.resume();
            };
            const playTone = (freq, type, duration, volume = 0.05) => {
                initAudio();
                const ctx = audioCtx.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type; 
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                gain.gain.setValueAtTime(volume, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + duration);
            };
            return {
                click: () => playTone(1200, 'sine', 0.1),
                type: () => playTone(2000, 'sine', 0.03, 0.02),
                alert: () => { playTone(600, 'square', 0.1, 0.1); setTimeout(() => playTone(450, 'square', 0.1, 0.1), 100); },
                success: () => { playTone(440, 'sine', 0.1); setTimeout(() => playTone(880, 'triangle', 0.2), 100); },
                error: () => playTone(150, 'sawtooth', 0.3),
                modernLogin: () => {
                    initAudio();
                    const now = audioCtx.current.currentTime;
                    const osc1 = audioCtx.current.createOscillator();
                    const g1 = audioCtx.current.createGain();
                    osc1.frequency.setValueAtTime(110, now);
                    osc1.frequency.exponentialRampToValueAtTime(440, now + 0.6);
                    g1.gain.setValueAtTime(0, now);
                    g1.gain.linearRampToValueAtTime(0.3, now + 0.1);
                    g1.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                    osc1.connect(g1); g1.connect(audioCtx.current.destination);
                    osc1.start(now); osc1.stop(now + 0.8);
                },
                powerup: () => {
                    playTone(392.00, 'square', 0.1, 0.1); setTimeout(() => playTone(587.33, 'square', 0.1, 0.1), 120);
                }
            };
        };

        /* --- OVERLAY COMPONENTS --- */
        const IntroOverlay = ({ videoUrl, buttonText, onComplete }) => {
            const videoRef = useRef(null);
            const [started, setStarted] = useState(false);

            const play = () => {
                if(videoRef.current) {
                    setStarted(true);
                    videoRef.current.play().catch(e => console.log("Play failed", e));
                }
            };

            return (
                <div className="intro-overlay-container">
                    {!started && (
                        <div className="text-center animate-fadeIn z-50">
                            <h1 className="text-3xl font-bold text-[#39ff14] text-neon-pulse mb-4">XRPL CHECKBOOK</h1>
                            <button 
                                onClick={play} 
                                className="border border-[#39ff14] text-[#39ff14] px-8 py-4 text-xl font-bold tracking-widest hover:bg-[#39ff14] hover:text-black transition shadow-[0_0_20px_#39ff14]"
                            >
                                {buttonText}
                            </button>
                        </div>
                    )}
                    <video
                        ref={videoRef}
                        src={videoUrl}
                        className={`absolute top-0 left-0 w-full h-full object-cover z-40 transition-opacity duration-1000 ${started ? 'opacity-100' : 'opacity-0'}`}
                        onEnded={onComplete}
                        playsInline
                    />
                    {/* Background blackout behind video */}
                    <div className="absolute top-0 left-0 w-full h-full bg-black z-30"></div>
                </div>
            );
        };

        /* --- BACKGROUND --- */
        const MovingBackground = () => {
            return (
                <div className="floating-bg">
                    {/* BACKGROUND VIDEO LAYER - LOOPED & MUTED */}
                    <video autoPlay loop muted playsInline className="absolute top-0 left-0 w-full h-full object-cover opacity-50 z-0 pointer-events-none">
                        <source src={INTERNAL_VIDEO_URL} type="video/mp4" />
                    </video>
                    {/* Dark Overlay for Readability */}
                    <div className="absolute top-0 left-0 w-full h-full bg-black/60 z-0 pointer-events-none"></div>

                    {/* Original Particles */}
                    {[...Array(12)].map((_, i) => (
                        <div key={i} className="xrp-logo" style={{ 
                            left: Math.random() * 100 + '%', 
                            width: Math.random() * 50 + 30 + 'px', 
                            height: Math.random() * 50 + 30 + 'px',
                            animationDuration: Math.random() * 25 + 15 + 's', 
                            animationDelay: Math.random() * 20 + 's' 
                        }}>
                            <svg viewBox="0 0 24 24" fill="currentColor" className="w-full h-full">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.65 14.65L12 12l-4.65 4.65-1.41-1.41L10.59 10.59 5.94 5.94l1.41-1.41L12 9.17l4.65-4.65 1.41 1.41L13.41 10.59l4.65 4.65-1.41 1.41z"/>
                            </svg>
                        </div>
                    ))}
                </div>
            );
        };

        /* --- MAIN APP --- */
        function App() {
            const sound = useSound();
            const [client, setClient] = useState(null);
            
            // Wallet State
            const [wallet, setWallet] = useState(null); 
            const [isWalletActive, setIsWalletActive] = useState(true); 
            const [allWallets, setAllWallets] = useState([]); 
            const [balance, setBalance] = useState("---");
            const [loginError, setLoginError] = useState(null); 
            
            const [network] = useState("wss://xrplcluster.com");
            const [seed, setSeed] = useState("");
            const [logs, setLogs] = useState([]);
            
            // View State
            const [activeTab, setActiveTab] = useState('WRITE');
            const [isBatchMode, setIsBatchMode] = useState(false);
            const [loading, setLoading] = useState(false);
            const [paymentMode, setPaymentMode] = useState('CHECK'); 
            
            // Toasts
            const [toasts, setToasts] = useState([]);

            // Modals & Tools
            const [confirmModal, setConfirmModal] = useState(null); 
            const [previewData, setPreviewData] = useState(null); 
            const [newWalletData, setNewWalletData] = useState(null);
            const [showAccountSwitcher, setShowAccountSwitcher] = useState(false);
            const [showAddWalletModal, setShowAddWalletModal] = useState(false);
            
            // Transaction History State
            const [txHistory, setTxHistory] = useState([]);
            const [txMarker, setTxMarker] = useState(null);
            const [historyLoading, setHistoryLoading] = useState(false);
            const [historyFilter, setHistoryFilter] = useState("");

            // Interactive Tour & Intro State
            const [tourActive, setTourActive] = useState(false);
            const [tourStep, setTourStep] = useState(0);
            const [tourRect, setTourRect] = useState(null);
            const [showSplash, setShowSplash] = useState(false); 
            const [showInternalIntro, setShowInternalIntro] = useState(false); 
            const [showSafetyNet, setShowSafetyNet] = useState(false); // New safety net state

            const internalIntroCheckedRef = useRef(false); // Ref to track intro status per session

            // Generate Mode
            const [genType, setGenType] = useState(null); 

            // Forms
            const [destAddress, setDestAddress] = useState("");
            const [amount, setAmount] = useState("");
            const [currencyType, setCurrencyType] = useState("XRP");
            const [iouCurrency, setIouCurrency] = useState("");
            const [iouIssuer, setIouIssuer] = useState("");
            const [memo, setMemo] = useState("");
            const [batchList, setBatchList] = useState("");
            
            // Data Arrays
            const [activeChecks, setActiveChecks] = useState([]);
            const [incomingChecks, setIncomingChecks] = useState([]);
            const [recentTransfers, setRecentTransfers] = useState([]); 
            
            // Wallet Data
            const [trustlines, setTrustlines] = useState([]);
            const [contacts, setContacts] = useState({});
            const [showContacts, setShowContacts] = useState(false);
            const [newContactName, setNewContactName] = useState("");
            
            // Receive Request (QR Only)
            const [requestQR, setRequestQR] = useState("");

            // KEYBOARD STATE
            const [showKeyboard, setShowKeyboard] = useState(false);

            const fileInputRef = useRef(null);
            const logEndRef = useRef(null);

            // --- MOUNT EFFECT: CHECK SPLASH ---
            useEffect(() => {
                const saved = localStorage.getItem('xrpl_address_book');
                if (saved) { try { setContacts(JSON.parse(saved) || {}); } catch (e) {} }

                // Check Splash Status (Cold Boot)
                if (!localStorage.getItem(SPLASH_KEY)) {
                    setShowSplash(true);
                }
            }, []);

            useEffect(() => { logEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [logs]);

            // KEYBOARD HANDLERS
            const handleKeyChar = (char) => {
                if (typeof char === 'string') setSeed(prev => prev + char);
            };
            const handleKeyBackspace = () => {
                setSeed(prev => prev.slice(0, -1));
            };

            // --- INTRO & TOUR FLOW LOGIC ---
            
            // 0. Handle Splash Completion
            const handleSplashComplete = () => {
                setShowSplash(false);
                localStorage.setItem(SPLASH_KEY, 'seen');
            };

            // 1. Trigger Internal Intro logic AFTER login is complete
            const handlePostLoginFlow = () => {
                // SESSION GUARD: Check if we have already handled the intro in this session
                if (internalIntroCheckedRef.current) return;
                
                // STORAGE GUARD: Check if internal intro has EVER been seen
                const introSeen = localStorage.getItem(INTERNAL_INTRO_KEY);
                
                if (!introSeen) {
                    // Show Internal Intro if never seen
                    setShowInternalIntro(true); 
                } else if (!localStorage.getItem(TOUR_KEY)) {
                    // Skip Intro, Show Tour if Intro seen but Tour not
                    startTour();
                }
                
                // Mark this session as having checked the intro
                internalIntroCheckedRef.current = true;
            };

            // 2. Handle Internal Intro Completion
            const handleInternalIntroComplete = () => {
                setShowInternalIntro(false);
                localStorage.setItem(INTERNAL_INTRO_KEY, 'seen');
                // Immediately start tour after video
                startTour();
            };

            // 3. Manual Reset (The '?' Button)
            // UPDATED: Now only resets the Tutorial Sequence (Checkbook Video + Tooltips), NOT Splash.
            const replayTutorialSequence = () => {
                sound.click();
                
                // Clear only internal flags
                localStorage.removeItem(INTERNAL_INTRO_KEY);
                localStorage.removeItem(TOUR_KEY);
                
                // Allow replay in session
                internalIntroCheckedRef.current = false;
                
                // Start sequence: Checkbook Video -> Tooltips
                setShowInternalIntro(true);
            };

            // --- TOUR HIGHLIGHTING LOGIC ---
            const waitForElement = (selector, retries = 0) => {
                const el = document.querySelector(selector);
                if (el) {
                    // Found it
                    el.classList.add('tour-highlighted-element');
                    const rect = el.getBoundingClientRect();
                    setTourRect(rect);
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // SIMULATION LOGIC: If this step has a simulation, trigger it
                    const step = TOUR_STEPS[tourStep];
                    if (step.isSimulation) {
                        setDestAddress(DEMO_ADDR);
                        setAmount(DEMO_AMT);
                    }
                    return;
                }
                
                // Retry up to 10 times (2 seconds)
                if (retries < 20) {
                    setTimeout(() => waitForElement(selector, retries + 1), 100);
                } else {
                    // Element never showed up, skip step
                    if (tourStep < TOUR_STEPS.length - 1) {
                         setTourStep(s => s + 1);
                    } else {
                        endTour();
                    }
                }
            };

            // Safety timer for stuck steps
            useEffect(() => {
                let safetyTimer;
                if (tourActive) {
                    setShowSafetyNet(false); // Reset
                    safetyTimer = setTimeout(() => {
                        setShowSafetyNet(true); // Show manual next button after 3s
                    }, 3000);
                }
                return () => clearTimeout(safetyTimer);
            }, [tourActive, tourStep]);

            useEffect(() => {
                document.querySelectorAll('.tour-highlighted-element').forEach(el => {
                    el.classList.remove('tour-highlighted-element');
                });

                if (tourActive && wallet && !showInternalIntro) { 
                    const step = TOUR_STEPS[tourStep];
                    if (!step) {
                        endTour();
                        return;
                    }
                    if (step.tab && activeTab !== step.tab) {
                        setActiveTab(step.tab);
                    }
                    setTimeout(() => {
                        waitForElement(step.selector);
                    }, 200);
                }
            }, [tourActive, tourStep, activeTab, wallet, showInternalIntro]);

            // Global listener for interactive tour
            useEffect(() => {
                if (!tourActive || showInternalIntro) return;

                const handleTourClick = (e) => {
                    // Allow clicks on the tooltip buttons (Exit)
                    if (e.target.closest('.tour-tooltip-box')) return;

                    const step = TOUR_STEPS[tourStep];
                    if (!step) return;
                    
                    const targetEl = document.querySelector(step.selector);
                    
                    if (targetEl && (e.target === targetEl || targetEl.contains(e.target))) {
                        // INTERCEPT SIMULATION CLICK
                        if (step.isSimulation) {
                            e.stopPropagation();
                            e.preventDefault();
                            sound.powerup();
                            addToast("SIMULATION: Transaction successfully signed & submitted!", "success");
                            addLog("SIMULATED TX: 50 XRP sent to rDemo...", "success");
                            
                            setTimeout(() => {
                                if (tourStep < TOUR_STEPS.length - 1) {
                                    setTourStep(s => s + 1);
                                    setDestAddress("");
                                    setAmount("");
                                } else {
                                    endTour();
                                }
                            }, 1500);
                            return;
                        }

                        // Normal Click Advance
                        // We use a small delay to let the UI react (tab switch etc) before finding next element
                        setTimeout(() => {
                            sound.click();
                            if (tourStep < TOUR_STEPS.length - 1) {
                                setTourStep(s => s + 1);
                            } else {
                                endTour();
                            }
                        }, 100);

                    } else {
                        // WRONG CLICK - BLOCK IT
                        e.stopPropagation();
                        e.preventDefault();
                        const tooltip = document.querySelector('.tour-tooltip-box');
                        if(tooltip) {
                            tooltip.classList.remove('animate-shake');
                            void tooltip.offsetWidth; 
                            tooltip.classList.add('animate-shake');
                        }
                    }
                };

                window.addEventListener('click', handleTourClick, true);
                return () => window.removeEventListener('click', handleTourClick, true);
            }, [tourActive, tourStep, showInternalIntro]);

            const startTour = () => {
                setActiveTab('WRITE');
                setTourStep(0);
                setTourActive(true);
            };

            const endTour = () => {
                setTourActive(false);
                setTourRect(null);
                document.querySelectorAll('.tour-highlighted-element').forEach(el => el.classList.remove('tour-highlighted-element'));
                localStorage.setItem(TOUR_KEY, 'seen'); // Save persistence HERE
                sound.success();
            };

            const forceNextStep = () => {
                if (tourStep < TOUR_STEPS.length - 1) {
                    setTourStep(s => s + 1);
                } else {
                    endTour();
                }
            };

            // --- TOAST LOGIC ---
            const addToast = (msg, type = 'info') => {
                const id = Date.now() + Math.random();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 4000);
            };

            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

            const addLog = (msg, type='info') => {
                setLogs(p => [...p, { time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}), msg, type }]);
                addToast(msg, type);
                if(type === 'error') s