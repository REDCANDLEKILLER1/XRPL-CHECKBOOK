<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>XRPMAN SHADOW WATCH // v9.9 [ICONS ONLINE]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --lime-main: #00ff00;
            --lime-dim: #004400;
            --glass-bg: rgba(0, 10, 0, 0.94);
            --alert-red: #ff0000;
            --ghost-gray: #444444;
            --warn-orange: #ffaa00;
            --info-cyan: #00ffff;
            --dex-purple: #aa00ff;
            --gold-hvt: #ffd700;
        }

        body {
            margin: 0; overflow: hidden; background-color: #000;
            font-family: 'Rajdhani', sans-serif; color: var(--lime-main);
            touch-action: none; user-select: none;
        }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; inset: 0; z-index: 9999;
            background-color: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease-out;
        }
        #splash-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; display: none; z-index: 0;
        }
        #boot-container {
            z-index: 10000; display: flex; flex-direction: column; gap: 20px; align-items: center;
        }
        #boot-btn {
            background: #000; border: 2px solid var(--lime-main);
            color: var(--lime-main); padding: 15px 30px;
            font-family: 'Orbitron', sans-serif; font-size: 16px; letter-spacing: 4px;
            cursor: pointer; box-shadow: 0 0 20px var(--lime-main);
            animation: pulse-green 2s infinite;
        }
        #skip-btn {
            position: absolute; top: 30px; right: 30px; z-index: 10001;
            background: rgba(0,0,0,0.7); border: 1px solid #333; color: #666;
            padding: 8px 15px; font-family: 'Share Tech Mono'; font-size: 12px;
            cursor: pointer; display: block;
        }
        #skip-btn:hover { border-color: var(--lime-main); color: var(--lime-main); }
        
        .fade-out { opacity: 0; pointer-events: none; }

        /* TUTORIAL OVERLAY */
        #tutorial-overlay {
            position: fixed; inset: 0; z-index: 5000; background: rgba(0,0,0,0.85);
            display: none; pointer-events: auto;
        }
        .tut-active { display: block !important; }
        .highlight-element {
            position: relative; z-index: 5001 !important;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.85), 0 0 20px var(--lime-main);
            pointer-events: none;
        }
        #tut-card {
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(0, 20, 0, 0.95); border: 2px solid var(--lime-main);
            padding: 20px; border-radius: 8px; z-index: 5002;
            text-align: center; box-shadow: 0 0 30px var(--lime-main);
        }
        .tut-title { font-family: 'Orbitron'; font-weight: bold; color: white; margin-bottom: 10px; font-size: 18px; }
        .tut-text { font-family: 'Share Tech Mono'; color: #ccc; font-size: 14px; line-height: 1.4; margin-bottom: 20px; }
        .tut-controls { display: flex; gap: 10px; justify-content: center; }
        .tut-btn {
            padding: 8px 20px; border: 1px solid var(--lime-main); background: #001100;
            color: var(--lime-main); font-family: 'Share Tech Mono'; font-weight: bold; cursor: pointer;
        }

        #app-background {
            position: absolute; inset: 0; z-index: 0;
            background: radial-gradient(circle at center, #002200 0%, #000000 70%);
        }
        #canvas-container { position: absolute; inset: 0; z-index: 1; opacity: 0.8; }
        #alert-layer { position: absolute; inset: 0; z-index: 900; pointer-events: none; }

        #toast {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 50, 0, 0.95); border: 1px solid var(--lime-main);
            color: white; padding: 12px 24px; border-radius: 4px;
            font-family: 'Share Tech Mono'; font-size: 14px; letter-spacing: 1px;
            opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 6000;
            box-shadow: 0 0 30px var(--lime-main); font-weight: bold; text-align: center;
        }
        .toast-show { opacity: 1 !important; }

        /* BUBBLE MODAL */
        #bubble-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 350px;
            background: rgba(0, 20, 0, 0.98); border: 2px solid var(--lime-main);
            border-radius: 12px; padding: 20px; z-index: 2000;
            display: none; flex-direction: column; gap: 10px;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.3);
        }
        .modal-active { display: flex !important; }
        .modal-row { display: flex; justify-content: space-between; font-size: 12px; border-bottom: 1px solid #113311; padding-bottom: 5px; }
        .modal-label { color: #55aa55; font-weight: bold; }
        .modal-val { color: white; font-family: 'Share Tech Mono'; text-align: right; word-break: break-all; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .mod-btn {
            background: #001100; border: 1px solid var(--lime-main); color: var(--lime-main);
            padding: 10px; font-size: 10px; font-weight: bold; text-align: center; border-radius: 4px;
            font-family: 'Share Tech Mono'; cursor: pointer; transition: background 0.1s;
        }
        .mod-btn:active { background: var(--lime-main); color: black; }
        .mod-save { border-color: #ffaa00; color: #ffaa00; }

        /* TOP HUD */
        #hud-top {
            position: absolute; top: 0; left: 0; right: 0; z-index: 20;
            background: linear-gradient(to bottom, rgba(0,0,0,0.95) 70%, transparent);
            padding-top: max(10px, env(safe-area-inset-top)); 
            padding-left: 15px; padding-right: 15px; padding-bottom: 20px;
            pointer-events: none; display: flex; flex-direction: column; gap: 8px;
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; pointer-events: auto; margin-bottom: 5px; }
        .stat-box {
            background: rgba(0, 20, 0, 0.9); border: 1px solid var(--lime-dim);
            padding: 8px; border-radius: 6px; backdrop-filter: blur(10px);
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        .price-text { font-family: 'Share Tech Mono', monospace; font-size: 1.4rem; font-weight: bold; color: #fff; text-shadow: 0 0 5px var(--lime-main); }
        .label-text { font-size: 0.65rem; color: #55aa55; letter-spacing: 1px; font-weight: bold; }
        .source-tag { font-size: 0.5rem; color: #338833; float: right; }
        
        .header-section { text-align: center; pointer-events: auto; position: relative; }
        .glitch { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.2rem; color: var(--lime-main); letter-spacing: 2px; text-shadow: 0 0 10px var(--lime-main); }
        .subtitle { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; color: var(--lime-main); letter-spacing: 3px; opacity: 0.8; }
        
        #help-btn {
            position: absolute; right: 0; top: 0; width: 30px; height: 30px;
            border: 1px solid #333; color: #666; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
            font-size: 12px; cursor: pointer;
        }

        .connect-container { display: flex; justify-content: center; gap: 10px; width: 100%; pointer-events: auto; }
        .connect-btn {
            background: #001100; border: 2px solid var(--lime-main);
            color: var(--lime-main); padding: 8px 30px; font-weight: 900; font-size: 12px;
            letter-spacing: 2px; border-radius: 6px;
            box-shadow: 0 0 15px rgba(0,255,0,0.3); transition: all 0.2s;
            font-family: 'Orbitron', sans-serif; text-transform: uppercase; cursor: pointer;
        }
        .connect-btn:active { background: var(--lime-main); color: black; box-shadow: 0 0 25px var(--lime-main); }
        .audio-btn {
            background: #001100; border: 1px solid var(--warn-orange); color: var(--warn-orange);
            padding: 8px 15px; font-weight: bold; font-size: 10px; border-radius: 6px;
            font-family: 'Share Tech Mono'; display: none; cursor: pointer;
        }

        /* BOTTOM DECK */
        #hud-bottom {
            position: absolute; bottom: 0; left: 0; right: 0; height: 55vh; z-index: 30;
            display: flex; flex-direction: column; pointer-events: auto;
        }
        #command-deck {
            flex-grow: 1; background: var(--glass-bg); border-top: 2px solid var(--lime-dim);
            backdrop-filter: blur(12px); display: flex; flex-direction: column;
            border-radius: 16px 16px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.8); overflow: hidden;
        }

        .tab-bar { display: flex; border-bottom: 1px solid var(--lime-dim); height: 45px; flex-shrink: 0; }
        .tab-btn {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 11px; background: rgba(0,20,0,0.4); color: #00aa00;
            border-right: 1px solid var(--lime-dim); letter-spacing: 1px; font-family: 'Orbitron', sans-serif;
            cursor: pointer;
        }
        .tab-btn.active { background: #001100; color: var(--lime-main); border-bottom: 3px solid var(--lime-main); text-shadow: 0 0 10px var(--lime-main); }
        .tab-btn.hvt-active { color: var(--gold-hvt); text-shadow: 0 0 5px var(--gold-hvt); }

        .view-panel { display: none; flex-direction: column; height: 100%; padding: 0; position: relative; overflow: hidden; }
        .view-panel.active { display: flex; }

        .filter-bar { display: flex; gap: 5px; padding: 8px; border-bottom: 1px solid var(--lime-dim); background: rgba(0,0,0,0.3); flex-shrink: 0; overflow-x: auto; }
        .filter-btn {
            flex: 1; min-width: 60px; background: #002200; border: 1px solid var(--lime-dim); color: #008800;
            font-size: 10px; padding: 4px; border-radius: 4px; font-weight: bold; white-space: nowrap; cursor: pointer;
        }
        .filter-btn.active { background: var(--lime-main); color: black; border-color: var(--lime-main); }

        #feed, #watch-list, #case-list, #report-list, #hvt-list { 
            flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: pan-y; padding-bottom: 40px;
        }

        .tx-row { padding: 10px; border-bottom: 1px solid #112211; display: flex; flex-direction: column; gap: 4px; }
        .row-top { display: flex; justify-content: space-between; align-items: center; }
        
        .tag-pill { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; margin-left: 6px; font-family: 'Share Tech Mono'; }
        .tag-tsfr { background: #003300; color: #00ff00; border: 1px solid #005500; }
        .tag-dep { background: #442200; color: #ffaa00; border: 1px solid #663300; }
        .tag-wth { background: #003344; color: #00ffff; border: 1px solid #005566; }
        .tag-dex { background: #330044; color: #aa00ff; border: 1px solid #550066; }
        .tag-fail { background: #333; color: #aaa; border: 1px solid #555; }
        .tag-hvt { background: #443300; color: #ffd700; border: 1px solid #ffd700; box-shadow: 0 0 5px #ffd700; animation: blink-hvt 1s infinite; }
        .tag-l2 { background: #003344; color: #00ffff; border: 1px solid #00aaaa; }
        
        @keyframes blink-hvt { 50% { opacity: 0.5; } }

        .tx-failed { opacity: 0.5; border-left: 3px solid #555; background: rgba(20,20,20,0.5); }
        .tx-failed .action-btn { border-color: #333; color: #555; }

        .btn-row { display: flex; gap: 5px; margin-top: 4px; }
        .action-btn {
            flex: 1; padding: 8px 0; text-align: center; border-radius: 2px;
            font-size: 10px; font-weight: bold; font-family: 'Share Tech Mono';
            background: #001100; color: #008800; border: 1px solid var(--lime-dim); cursor: pointer;
        }
        .action-btn:active { background: var(--lime-main); color: black; }
        .entity-name { color: #ffcc00; font-weight: bold; }

        .control-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; border-bottom: 1px solid var(--lime-dim); background: rgba(0,0,0,0.5); flex-shrink: 0;
        }
        .pause-btn {
            background: #002200; border: 1px solid var(--lime-main); color: var(--lime-main);
            padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; font-family: 'Share Tech Mono'; cursor: pointer;
        }
        .paused-mode { background: #442200 !important; border-color: #ffaa00 !important; color: #ffaa00 !important; }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 10px var(--lime-main); }
            50% { box-shadow: 0 0 30px var(--lime-main), inset 0 0 10px var(--lime-main); }
            100% { box-shadow: 0 0 10px var(--lime-main); }
        }

        @keyframes border-flash {
            0% { box-shadow: inset 0 0 0 0 transparent; }
            50% { box-shadow: inset 0 0 50px 20px var(--lime-main); }
            100% { box-shadow: inset 0 0 0 0 transparent; }
        }
        .whale-alert-anim { animation: border-flash 1s ease-in-out 3; position: absolute; inset: 0; pointer-events: none; z-index: 900; }
        
        @keyframes red-flash { 0% { box-shadow: inset 0 0 0 0 transparent; } 50% { box-shadow: inset 0 0 50px 20px var(--alert-red); } 100% { box-shadow: inset 0 0 0 0 transparent; } }
        .hvt-alert-anim { animation: red-flash 0.5s ease-in-out 6; position: absolute; inset: 0; pointer-events: none; z-index: 950; }

        /* --- MAP & REPORT STYLES --- */
        #map-canvas { width: 100%; height: 100%; display: block; }
        #map-legend { position: absolute; bottom: 10px; left: 10px; right: 10px; display: flex; gap: 5px; flex-wrap: wrap; pointer-events: none; }
        .legend-item { font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-family: 'Share Tech Mono'; background: rgba(0,0,0,0.8); border: 1px solid #333; }

        #report-header { display: flex; justify-content: space-between; padding: 8px 10px; background: rgba(0, 50, 0, 0.3); border-bottom: 1px solid var(--lime-dim); font-size: 9px; font-weight: bold; color: #55aa55; font-family: 'Share Tech Mono'; }
        .rep-col-time { width: 50px; text-align: right; }
        .rep-col-type { width: 30px; text-align: center; }
        .rep-col-out { width: 35px; text-align: center; } 
        .report-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #112211; font-size: 10px; font-family: 'Share Tech Mono'; cursor: pointer; }
        .report-row:hover { background: rgba(0, 255, 0, 0.1); }
        .rep-val-green { color: #00ff00; } .rep-val-white { color: #ffffff; } .rep-val-dim { color: #888888; }

    </style>
</head>
<body>

    <!-- VIDEO SPLASH SCREEN (LOOP REMOVED) -->
    <div id="splash-screen">
        <video id="splash-video" playsinline muted autoplay>
            <source src="https://ipfs.filebase.io/ipfs/QmVMYvMffwSXPJyuNz3CAW8V6rS1wViWQjPHdzPGofb7Ux" type="video/mp4">
        </video>
        <button id="skip-btn" onclick="skipBoot()">[ SKIP INTRO ]</button>
        <div id="boot-container">
            <button id="boot-btn" onclick="bootSystem()">SYSTEM BOOT</button>
        </div>
    </div>

    <!-- TUTORIAL OVERLAY -->
    <div id="tutorial-overlay">
        <div id="tut-card">
            <div class="tut-title" id="tut-title">WELCOME AGENT</div>
            <div class="tut-text" id="tut-text">
                Welcome to XRPMAN SHADOW WATCH.
                This forensic tool tracks the XRP Ledger in real-time.
                <br><br>Let's calibrate your system.
            </div>
            <div class="tut-controls">
                <button class="tut-btn" onclick="endTutorial()">SKIP</button>
                <button class="tut-btn" onclick="nextStep()">NEXT ></button>
            </div>
        </div>
    </div>

    <!-- BUBBLE/REPORT DETAIL MODAL -->
    <div id="bubble-modal">
        <div class="text-center text-lg font-bold text-white mb-2 border-b border-green-900 pb-2">TRANSACTION INTEL</div>
        <div class="modal-row"><span class="modal-label">AMOUNT:</span><span id="mod-amt" class="modal-val text-xl text-yellow-400">---</span></div>
        <div class="modal-row"><span class="modal-label">TYPE:</span><span id="mod-type" class="modal-val">---</span></div>
        <div class="modal-row"><span class="modal-label">SENDER:</span><span id="mod-from" class="modal-val text-[10px]">---</span></div>
        <div class="modal-row"><span class="modal-label">TARGET:</span><span id="mod-to" class="modal-val text-[10px]">---</span></div>
        <div class="modal-grid">
            <button id="mod-scan-btn" class="mod-btn">SCAN LEDGER</button>
            <button id="mod-copy-hash" class="mod-btn">COPY HASH</button>
            <button id="mod-copy-wallet" class="mod-btn">COPY SENDER</button>
            <button id="mod-save-btn" class="mod-btn mod-save">SAVE EVID</button>
        </div>
        <button onclick="closeModal()" class="w-full text-red-500 text-xs mt-4">CLOSE INTEL</button>
    </div>

    <div id="toast">NOTIFICATION</div>
    <div id="app-background"></div>
    <div id="canvas-container"></div>
    <div id="alert-layer"></div>

    <!-- TOP HUD -->
    <div id="hud-top">
        <div class="stat-grid">
            <div class="stat-box">
                <div id="price-label" class="label-text">XRP / USD <span id="price-source" class="source-tag">SCANNING...</span></div>
                <div id="price-display" class="price-text">---</div>
            </div>
            <div class="stat-box text-right">
                <div class="label-text">LEDGER INDEX</div>
                <div id="ledger-display" class="price-text text-green-700">OFFLINE</div>
            </div>
        </div>

        <div class="header-section">
            <h1 class="glitch">XRPMAN SHADOW WATCH</h1>
            <div class="subtitle">POWERED BY $XMEME</div>
            <button id="help-btn" onclick="startTutorial()">?</button>
        </div>

        <div class="connect-container" id="init-zone">
            <button id="connect-main" onclick="toggleConnection()" class="connect-btn">INITIALIZE UPLINK</button>
            <button id="audio-btn" onclick="toggleAudio()" class="audio-btn">ENABLE AUDIO</button>
        </div>
    </div>

    <!-- BOTTOM DECK -->
    <div id="hud-bottom">
        <div id="command-deck">
            <div class="tab-bar" id="tab-zone">
                <div class="tab-btn active" onclick="switchView('live')">LIVE</div>
                <div class="tab-btn" onclick="switchView('hvt')" style="color: gold;">[ HVT ]</div>
                <div class="tab-btn" onclick="switchView('map')">MAP</div>
                <div class="tab-btn" onclick="switchView('report')">REPORT</div>
                <div class="tab-btn" onclick="switchView('case')">EVID</div>
            </div>

            <!-- LIVE TAB -->
            <div id="view-live" class="view-panel active">
                <div class="filter-bar" id="filter-zone">
                    <button class="filter-btn active" onclick="setFilter('all', this)">[ ALL ]</button>
                    <button class="filter-btn" onclick="setFilter('small', this)">[ &lt; 100K ]</button>
                    <button class="filter-btn" onclick="setFilter('whale', this)">[ WHALES ]</button>
                    <button class="filter-btn" onclick="setFilter('exchange', this)">[ EXCH ]</button>
                    <button class="filter-btn" style="border-color:#00ffff; color:#00ffff;" onclick="setFilter('l2', this)">[ L2 ]</button>
                    <label class="flex items-center gap-1 text-[9px] text-green-400 font-bold ml-2">
                        <input type="checkbox" id="hide-failed" checked class="accent-green-500"> NO GHOSTS
                    </label>
                </div>
                <div class="control-bar">
                    <span class="text-[10px] text-gray-400">STATUS: <span id="status-text" class="text-green-500">ACTIVE</span></span>
                    <button id="pause-btn" class="pause-btn" onclick="togglePause()">PAUSE STREAM</button>
                </div>
                <div id="feed">
                    <div class="text-center text-green-800 mt-12 font-tech text-xs tracking-widest">
                        AWAITING UPLINK...
                    </div>
                </div>
            </div>

            <!-- HVT TAB -->
            <div id="view-hvt" class="view-panel">
                <div class="p-2 border-b border-green-900 bg-black/40 text-center">
                    <span class="text-xs text-yellow-400 font-bold tracking-widest">>> HIGH VALUE TARGET BLACK BOX <<</span>
                </div>
                <div id="hvt-list">
                    <div class="text-center text-gray-600 mt-12 font-tech text-xs">MONITORING FOR FOUNDERS / RIPPLE OPS...</div>
                </div>
            </div>

            <!-- MAP TAB -->
            <div id="view-map" class="view-panel">
                <canvas id="map-canvas"></canvas>
                <div id="map-legend">
                    <div class="legend-item" style="color:#00ff00; border-color:#005500;">TSFR</div>
                    <div class="legend-item" style="color:#ffaa00; border-color:#663300;">DEPOSIT</div>
                    <div class="legend-item" style="color:#ffd700; border-color:#555500;">HVT</div>
                    <div class="legend-item" style="color:#00ffff; border-color:#005566;">L2</div>
                </div>
            </div>

            <!-- REPORT TAB -->
            <div id="view-report" class="view-panel">
                <div id="report-header">
                    <div style="width: 25%">AMT</div>
                    <div style="width: 25%">WALLET</div>
                    <div class="rep-col-time">TIME</div>
                    <div class="rep-col-type">TYPE</div>
                    <div class="rep-col-out">OUT</div>
                </div>
                <div id="report-list">
                    <div class="text-center text-gray-600 mt-12 font-tech text-xs tracking-widest">WAITING FOR 100K+ TXs...</div>
                </div>
            </div>

            <!-- WATCH TAB -->
            <div id="view-watch" class="view-panel p-4">
                <div class="flex gap-2 p-2 bg-black/50 border border-green-900 mb-2 flex-shrink-0">
                    <input type="text" id="watch-input" placeholder="Enter rAddress..." class="flex-grow bg-transparent text-white text-xs outline-none font-tech">
                    <button onclick="addWatch()" class="text-green-500 font-bold text-xs uppercase">Track</button>
                </div>
                <div id="watch-list" class="flex-grow overflow-y-auto space-y-1"></div>
            </div>

            <!-- CASE TAB -->
            <div id="view-case" class="view-panel">
                <div class="flex justify-between p-3 border-b border-green-900 bg-black/20 flex-shrink-0">
                    <span class="text-xs text-green-700">SAVED ANOMALIES</span>
                    <button onclick="exportJSON()" class="text-[10px] text-green-400 border border-green-600 px-3 rounded">EXPORT</button>
                </div>
                <div id="case-list" class="flex-grow overflow-y-auto space-y-1 p-2"></div>
                <button onclick="clearCases()" class="text-red-500 text-xs py-4 bg-red-900/10 font-bold tracking-widest border-t border-red-900 flex-shrink-0">CLEAR LOCKER</button>
            </div>
        </div>
    </div>

    <script>
        // --- BOOT SEQUENCE WITH VIDEO ---
        function bootSystem() {
            const vid = document.getElementById('splash-video');
            const btn = document.getElementById('boot-btn');
            
            btn.style.display = 'none'; 
            vid.style.display = 'block'; 
            vid.style.zIndex = '50';
            
            // Unmute on interaction for sound
            vid.muted = false;
            vid.volume = 1.0; 
            vid.currentTime = 0;
            vid.play().catch(e => {
                console.log("Audio Blocked", e);
                // If blocked, just finish
                finishBoot();
            });
            
            // When video ends or after 5.5 seconds (safety)
            vid.onended = () => finishBoot();
            setTimeout(finishBoot, 5500); 
        }

        function skipBoot() {
            const vid = document.getElementById('splash-video');
            vid.pause();
            finishBoot();
        }

        function finishBoot() {
            const vid = document.getElementById('splash-video');
            if(vid) vid.pause(); // Ensure clean cut
            
            document.getElementById('splash-screen').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
                checkTutorial();
            }, 800);
        }

        // --- TUTORIAL SYSTEM ---
        let tutStep = 0;
        
        function checkTutorial() {
            if(!localStorage.getItem("shadow_watch_tut")) {
                startTutorial();
                localStorage.setItem("shadow_watch_tut", "true");
            }
        }

        function startTutorial() {
            tutStep = 0;
            document.getElementById('tutorial-overlay').classList.add('tut-active');
            updateTutorial();
        }

        function endTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('tut-active');
            document.querySelectorAll('.highlight-element').forEach(e => e.classList.remove('highlight-element'));
        }

        function nextStep() {
            tutStep++;
            updateTutorial();
        }

        function updateTutorial() {
            // Clear previous highlight
            document.querySelectorAll('.highlight-element').forEach(e => e.classList.remove('highlight-element'));
            const title = document.getElementById('tut-title');
            const text = document.getElementById('tut-text');

            if(tutStep === 0) {
                // Intro is handled in startTutorial
            } else if (tutStep === 1) {
                title.innerText = "STEP 1: UPLINK";
                text.innerText = "Tap 'INITIALIZE UPLINK' to connect to the XRP Ledger node. Use 'ENABLE AUDIO' for alerts.";
                document.getElementById('init-zone').classList.add('highlight-element');
            } else if (tutStep === 2) {
                title.innerText = "STEP 2: FILTERS";
                text.innerText = "Use these tabs to filter the live stream. \n[WHALE] shows large txs.\n[< 100K] for small XRP.\n[L2] shows Tokens.";
                document.getElementById('filter-zone').classList.add('highlight-element');
            } else if (tutStep === 3) {
                title.innerText = "STEP 3: TACTICAL VIEWS";
                text.innerText = "[MAP] shows visual money flow.\n[REPORT] lists clean data for analysis.\n[HVT] records only known Targets (Founders/Ripple).";
                document.getElementById('tab-zone').classList.add('highlight-element');
            } else if (tutStep === 4) {
                title.innerText = "READY";
                text.innerText = "You are now operational. \nStay vigilant. Watch the shadows.";
                document.querySelector('.tut-controls').innerHTML = `<button class="tut-btn" onclick="endTutorial()">START</button>`;
            }
        }

        // --- 3D ENGINE ---
        let scene, camera, renderer, particles;
        const particleCount = 2500;

        function init3D() {
            const container = document.getElementById('canvas-container');
            if (!container) return;
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.01); 
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, -10, 30); camera.lookAt(0, 10, 0);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            
            const pGeo = new THREE.BufferGeometry();
            const pos = [], speeds = [];
            for(let i=0; i<particleCount; i++) {
                pos.push((Math.random()-0.5)*50, (Math.random()-0.5)*10-20, (Math.random()-0.5)*30);
                speeds.push(0.1 + Math.random() * 0.4);
            }
            pGeo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            pGeo.setAttribute('speed', new THREE.Float32BufferAttribute(speeds, 1));
            
            particles = new THREE.Points(pGeo, new THREE.PointsMaterial({
                color: 0x00ff00, size: 0.4, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending
            }));
            scene.add(particles);
            animate();
            
            let startX = 0;
            container.addEventListener('touchstart', e => startX = e.touches[0].clientX, {passive: true});
            container.addEventListener('touchmove', e => {
                camera.rotation.z -= (e.touches[0].clientX - startX) * 0.0005;
                startX = e.touches[0].clientX;
            }, {passive: true});

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!particles) return;
            const pos = particles.geometry.attributes.position.array;
            const spd = particles.geometry.attributes.speed.array;
            for(let i=0; i<particleCount; i++) {
                pos[i*3+1] += spd[i];
                if(pos[i*3+1] > 30) { pos[i*3+1] = -20; pos[i*3] = (Math.random()-0.5)*50; }
            }
            particles.geometry.attributes.position.needsUpdate = true;
            camera.position.x = Math.sin(Date.now()*0.0005)*2;
            renderer.render(scene, camera);
        }

        // --- AUDIO ENGINE ---
        let audioCtx;
        let audioEnabled = false;

        function toggleAudio() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            audioEnabled = !audioEnabled;
            const btn = document.getElementById('audio-btn');
            btn.innerText = audioEnabled ? "AUDIO ON" : "ENABLE AUDIO";
            btn.style.color = audioEnabled ? "#00ff00" : "#ffaa00";
            btn.style.borderColor = audioEnabled ? "#00ff00" : "#ffaa00";
            if(audioEnabled) playTone(600, 0.1, "sine"); // Test beep
        }

        function playTone(freq, duration, type="square") {
            if(!audioEnabled || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playAlert(type) {
            if (type === 'HVT') {
                playTone(1200, 0.1); setTimeout(() => playTone(1200, 0.1), 150); setTimeout(() => playTone(1200, 0.2), 300);
            } else {
                playTone(400, 0.2, "sine");
            }
        }

        // --- MAP ENGINE ---
        const mapCanvas = document.getElementById('map-canvas');
        const mapCtx = mapCanvas.getContext('2d');
        let bubbles = [];
        let mapActive = false;

        function resizeMap() {
            if(!mapCanvas.offsetParent) return;
            mapCanvas.width = mapCanvas.offsetWidth;
            mapCanvas.height = mapCanvas.offsetHeight;
        }

        class Bubble {
            // Updated Constructor to accept issuer for image loading
            constructor(label, val, color, hash, from, to, type, issuer) {
                this.x = Math.random() * mapCanvas.width;
                this.y = mapCanvas.height + 20;
                
                // Fixed radius math
                let safeVal = parseFloat(val) || 1; 
                this.radius = Math.max(10, Math.min(50, Math.log(safeVal + 10) * 3));
                
                this.speed = 1 + Math.random() * 2;
                this.color = color;
                this.hash = hash;
                this.label = label;
                this.val = val;     
                this.from = from;
                this.to = to;
                this.type = type;
                this.life = 1.0;

                // --- ICON LOGIC ---
                this.isL2 = type === 'L2' && issuer;
                this.icon = null;
                this.iconLoaded = false;

                if (this.isL2) {
                    this.icon = new Image();
                    this.icon.crossOrigin = "Anonymous"; // Clean practices
                    this.icon.src = `https://xumm.app/avatar/${issuer}_200.png`;
                    this.icon.onload = () => { this.iconLoaded = true; };
                    this.icon.onerror = () => { this.iconLoaded = false; this.icon = null; };
                }
            }
            update() { this.y -= this.speed; this.life -= 0.002; }
            draw() {
                mapCtx.globalAlpha = this.life;
                
                // Define the circle path
                mapCtx.beginPath();
                mapCtx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                
                // IMAGE RENDERING
                if (this.isL2 && this.iconLoaded && this.icon) {
                    mapCtx.save();
                    mapCtx.clip(); // Mask content to the circle
                    mapCtx.drawImage(this.icon, this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
                    mapCtx.restore();
                } else {
                    // Fallback to Solid Color
                    mapCtx.fillStyle = this.color;
                    mapCtx.fill();
                }

                // Border
                mapCtx.strokeStyle = "#fff"; mapCtx.lineWidth = 1; mapCtx.stroke();
                
                // Text Label
                if (this.radius > 12) {
                    mapCtx.textAlign = "center"; 
                    mapCtx.font = "bold 9px monospace";
                    
                    // Shadow/Stroke for readability over images
                    mapCtx.lineWidth = 3;
                    mapCtx.strokeStyle = "black";
                    mapCtx.strokeText(this.label, this.x, this.y + 3);
                    
                    mapCtx.fillStyle = "#fff"; 
                    mapCtx.fillText(this.label, this.x, this.y + 3);
                }
            }
        }

        function loopMap() {
            if (!mapActive) return;
            requestAnimationFrame(loopMap);
            mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
            for (let i = bubbles.length - 1; i >= 0; i--) {
                let b = bubbles[i]; b.update(); b.draw();
                if (b.y < -50 || b.life <= 0) bubbles.splice(i, 1);
            }
        }

        mapCanvas.addEventListener('click', (e) => {
            const rect = mapCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            for (let i = bubbles.length - 1; i >= 0; i--) {
                let b = bubbles[i];
                if (Math.hypot(b.x - x, b.y - y) < b.radius + 10) { openModal(b); bubbles.splice(i, 1); break; }
            }
        });

        // --- BUBBLE/REPORT MODAL ---
        function openModal(b) {
            document.getElementById('mod-amt').innerText = typeof b.val === 'number' ? b.val.toLocaleString() + " " + (b.type==='L2' ? b.label : 'XRP') : b.label;
            document.getElementById('mod-amt').style.color = b.color || '#00ff00';
            document.getElementById('mod-type').innerText = b.type || 'TX';
            document.getElementById('mod-from').innerText = b.from;
            document.getElementById('mod-to').innerText = b.to;
            
            // Assign Actions
            document.getElementById('mod-scan-btn').onclick = () => openScan(b.hash);
            document.getElementById('mod-copy-hash').onclick = () => copyHash(b.hash);
            document.getElementById('mod-copy-wallet').onclick = () => copyHash(b.from);
            document.getElementById('mod-save-btn').onclick = () => {
                saveCase({hash:b.hash, amt:b.val, from:b.from, to:b.to});
                closeModal();
                showToast("EVIDENCE SECURED");
            };
            document.getElementById('bubble-modal').classList.add('modal-active');
        }
        function closeModal() { document.getElementById('bubble-modal').classList.remove('modal-active'); }

        // --- APP LOGIC ---
        let socket, isConnected = false, watchlist = [], cases = [], hvtLog = [], priceInterval;
        let activeFilter = 'all'; 
        let lastAlertTime = 0;
        let isPaused = false;
        let lastHeartbeat = Date.now();
        let pingInterval;

        // THE BLACK BOOK
        const KNOWN_WALLETS = {
            'rLNaPoKeeBJZe2qs6x52yVPZpZ8td4dc6w': {name: 'COINBASE', type: 'EXCH'},
            'rEb8TK3gBgk5auZkwc6sHnwrGVJH8DuaLh': {name: 'BINANCE', type: 'EXCH'},
            'rJb5KsHsDHF1YSnasbwqSagepE8XXAuGh': {name: 'BITSTAMP', type: 'EXCH'},
            'rU2mEJSLqBRkYLVTv55rFTgQYkDBqVyTRn': {name: 'COINS.PH', type: 'EXCH'},
            'rNprNzNWKqaKUH24sF11g8n9C9r295x26d': {name: 'KRAKEN', type: 'EXCH'},
            'rHb9CJAWyB4rj91VRWn96DkukG4bwdtyTh': {name: 'GENESIS', type: 'HVT'},
            'r945F6e8...Escrow': {name: 'RIPPLE ESCROW', type: 'HVT'}, 
            'r...Tacostand': {name: 'TACOSTAND', type: 'HVT'},
            'r...Chris': {name: 'CHRIS LARSEN', type: 'HVT'},
            'r...Brad': {name: 'BRAD G.', type: 'HVT'}
        };

        // --- RECONNECTION LOGIC ---
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && isConnected) {
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    showToast("RE-ESTABLISHING UPLINK...");
                    startXRPL();
                }
            }
        });
        
        // PINGER LOOP: Keeps connection alive
        setInterval(() => {
            if (isConnected && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({command: "ping"}));
            }
        }, 15000); // Send ping every 15s

        // WATCHDOG LOOP: Checks for timeout
        setInterval(() => {
            // Increased timeout to 45 seconds to prevent false alarms
            if (isConnected && (Date.now() - lastHeartbeat > 45000)) {
                console.log("Heartbeat lost. Reconnecting..."); showToast("SIGNAL LOST. RECONNECTING..."); startXRPL();
            }
        }, 5000);

        function toggleConnection() {
            const btn = document.getElementById('connect-main');
            const priceLabel = document.getElementById('price-label'); 
            
            if(isConnected) {
                if(socket) socket.close();
                clearInterval(priceInterval);
                isConnected = false;
                btn.innerText = "INITIALIZE UPLINK"; btn.style.background = "#001100"; btn.style.color = "#00ff00";
                if(priceLabel) priceLabel.style.color = "#008800";
                showToast("SYSTEM HALTED");
            } else {
                startXRPL();
                startRedundantPriceEngine();
                isConnected = true;
                btn.innerText = "UPLINK ACTIVE"; btn.style.background = "#00ff00"; btn.style.color = "#000";
                document.getElementById('feed').innerHTML = '';
                document.getElementById('audio-btn').style.display = 'inline-block';
                showToast("FIREWALL BREACHED");
            }
        }

        function setFilter(mode, btn) {
            activeFilter = mode;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            let txt = mode === 'small' ? '< 100K' : mode.toUpperCase();
            document.getElementById('feed').innerHTML = `<div class="text-center text-green-800 mt-12 font-tech text-xs tracking-widest">FILTER ACTIVE: [ ${txt} ]<br>AWAITING NEW TARGETS...</div>`;
            showToast("FILTER: " + txt);
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pause-btn');
            const status = document.getElementById('status-text');
            if(isPaused) {
                btn.innerText = "RESUME"; btn.classList.add('paused-mode');
                status.innerText = "PAUSED"; status.classList.replace('text-green-500', 'text-yellow-500');
                showToast("STREAM FROZEN");
            } else {
                btn.innerText = "PAUSE STREAM"; btn.classList.remove('paused-mode');
                status.innerText = "ACTIVE"; status.classList.replace('text-yellow-500', 'text-green-500');
                showToast("STREAM RESUMED");
            }
        }

        const PRICE_SOURCES = [
            { id: 'BINANCE.US', url: 'https://api.binance.us/api/v3/ticker/price?symbol=XRPUSDT', parse: d => parseFloat(d.price) },
            { id: 'COINGECKO', url: 'https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd', parse: d => d.ripple.usd },
            { id: 'KRAKEN', url: 'https://api.kraken.com/0/public/Ticker?pair=XRPUSD', parse: d => parseFloat(d.result.XXRPZUSD.c[0]) }
        ];

        async function fetchPrice() {
            for (let source of PRICE_SOURCES) {
                try {
                    const c = new AbortController(); setTimeout(() => c.abort(), 2000); 
                    const res = await fetch(source.url, { signal: c.signal });
                    const data = await res.json();
                    const price = source.parse(data);
                    if (price && !isNaN(price)) { updatePriceDisplay(price, source.id); return; }
                } catch (e) {}
            }
            document.getElementById('price-display').innerText = "ERR";
        }

        function updatePriceDisplay(price, sourceId) {
            const el = document.getElementById('price-display');
            const srcEl = document.getElementById('price-source');
            const oldPrice = parseFloat(el.innerText.replace('$','')) || 0;
            el.innerText = `$${price.toFixed(4)}`;
            srcEl.innerText = `SRC: ${sourceId}`; srcEl.style.color = "#00ff00";
            el.style.color = price > oldPrice ? '#00ff00' : (price < oldPrice ? '#ff5555' : 'white');
        }

        function startRedundantPriceEngine() { fetchPrice(); priceInterval = setInterval(fetchPrice, 8000); }

        function startXRPL() {
            if(socket) socket.close();
            socket = new WebSocket('wss://s1.ripple.com');
            socket.onopen = () => {
                socket.send(JSON.stringify({command:"subscribe", streams:["transactions", "ledger"]}));
                lastHeartbeat = Date.now();
            };
            socket.onmessage = (e) => {
                lastHeartbeat = Date.now(); // Update heartbeat on ANY message (including ping response)
                const d = JSON.parse(e.data);
                if(d.type==='transaction') handleTx(d.transaction, d.meta);
                if(d.type==='ledgerClosed') document.getElementById('ledger-display').innerText = d.ledger_index;
            };
            socket.onclose = (e) => { 
                console.log("Socket closed");
                // If connected but closed unexpectedly, try to reconnect silently
                if(isConnected) {
                   setTimeout(startXRPL, 1000);
                }
            };
            socket.onerror = (e) => { console.log("Socket Error"); };
        }

        // --- UTILS: HEX TO STRING ---
        function hexToASCII(hex) {
            let str = '';
            for (let i = 0; i < hex.length; i += 2) {
                str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
            }
            // Remove null bytes
            return str.replace(/\0/g, '');
        }

        // --- CLASSIFICATION HELPERS ---
        function getReportType(amt, known) {
            if (known) return 'I';
            if (amt > 5000000) return 'S';
            return 'R';
        }

        function getOutflow(fromKnown, toKnown) {
            if (fromKnown) return 'Y';
            if (toKnown) return 'N';
            return 'P2P';
        }

        function handleTx(tx, meta) {
            if (isPaused) return; 
            if (tx.TransactionType !== 'Payment' && tx.TransactionType !== 'OfferCreate') return;
            
            let isSuccess = false;
            let result = meta?.TransactionResult || 'unknown';
            if (result === 'tesSUCCESS') isSuccess = true;

            const hideFailed = document.getElementById('hide-failed').checked;
            if (hideFailed && !isSuccess) return;

            let type = "TSFR";
            let color = "text-green-500";
            let mapColor = "#00ff00";
            let amt = 0;
            let isL2 = false;
            let tokenName = "XRP";
            let issuer = null; // NEW: Issuer Tracking
            
            // Resolve Entities
            const entFrom = KNOWN_WALLETS[tx.Account];
            const entTo = KNOWN_WALLETS[tx.Destination];
            let nameFrom = entFrom ? entFrom.name : null;
            let nameTo = entTo ? entTo.name : null;

            // Check HVT Status
            const isHVT = (entFrom && entFrom.type === 'HVT') || (entTo && entTo.type === 'HVT');

            // --- AMOUNT PARSING (XRP vs TOKEN) ---
            let delivered = meta?.delivered_amount;
            
            if (typeof tx.Amount === 'object' || (delivered && typeof delivered === 'object')) {
                 isL2 = true;
                 // Prioritize delivered_amount
                 if (delivered && typeof delivered === 'object') {
                     amt = parseFloat(delivered.value);
                     const currency = delivered.currency;
                     tokenName = currency.length > 3 ? hexToASCII(currency) : currency;
                     issuer = delivered.issuer; // Capture Issuer
                 } else {
                     // Fallback
                     amt = parseFloat(tx.Amount.value);
                     const currency = tx.Amount.currency;
                     tokenName = currency.length > 3 ? hexToASCII(currency) : currency;
                     issuer = tx.Amount.issuer; // Capture Issuer
                 }
                 type = "L2";
                 color = "text-cyan-400";
                 mapColor = "#00ffff";
                 
            } else if (typeof tx.Amount === 'string') {
                // XRP
                if (delivered && typeof delivered === 'string') {
                    amt = parseInt(delivered) / 1000000;
                } else {
                    amt = parseInt(tx.Amount) / 1000000;
                }
            } else if (tx.TransactionType === 'OfferCreate') {
                // DEX Order
                if (typeof tx.TakerPays === 'string') amt = parseInt(tx.TakerPays) / 1000000;
                else if (typeof tx.TakerGets === 'string') amt = parseInt(tx.TakerGets) / 1000000;
                type = "DEX";
                color = "text-purple-400";
                mapColor = "#aa00ff";
            }

            // COST CALCULATION
            let costDisplay = "";
            if (isL2 && tx.SendMax) {
                if (typeof tx.SendMax === 'string') {
                    let costXRP = parseInt(tx.SendMax) / 1000000;
                    costDisplay = `<span class="text-xs text-gray-500 ml-1">(${costXRP} XRP)</span>`;
                }
            }

            let tags = "";
            const isWhale = !isL2 && amt >= 1000000; 
            const isExchange = nameFrom || nameTo;

            if (tx.TransactionType === 'OfferCreate') {
                tags += `<span class="tag-pill tag-dex">DEX ORD</span>`;
            } else {
                if (isL2) {
                    tags += `<span class="tag-pill tag-l2">[ ${tokenName} ]</span>`;
                } else {
                    if (nameFrom) { 
                        type = "WTH"; color = "text-cyan-400"; mapColor="#00ffff";
                        tags += `<span class="tag-pill tag-wth">WITHDRAW</span>`;
                    }
                    else if (nameTo) { 
                        type = "DEP"; color = "text-yellow-500"; mapColor="#ffaa00";
                        tags += `<span class="tag-pill tag-dep">DEPOSIT</span>`;
                    }
                    else {
                        tags += `<span class="tag-pill tag-tsfr">TRANSFER</span>`;
                    }
                }
            }

            // FILTER LOGIC
            if (activeFilter === 'small') {
                if (isL2) return; 
                if (amt >= 100000) return; 
            }
            if (activeFilter === 'whale') {
                if (isL2) return;
                if (!isWhale) return;
            }
            if (activeFilter === 'exchange') {
                if (isL2) return;
                if (!isExchange) return;
            }
            if (activeFilter === 'l2' && !isL2) return;
            
            const now = Date.now();
            if (isWhale && isSuccess && (now - lastAlertTime > 60000)) {
                triggerWhaleAlert(); lastAlertTime = now;
                playAlert('WHALE');
            }

            // --- HVT LOGIC ---
            if (isHVT) {
                saveCase({hash:tx.hash, amt:amt, from:nameFrom||tx.Account, to:nameTo||tx.Destination, type:'HVT'});
                addHVTRow(tx.hash, amt, nameFrom||tx.Account, nameTo||tx.Destination);
                triggerHVTAlert();
                playAlert('HVT');
                color = "text-yellow-300";
                tags += `<span class="tag-pill tag-hvt">HVT TARGET</span>`;
            }

            let rowClass = "tx-row";
            if (!isSuccess) {
                color = "text-gray-500"; rowClass += " tx-failed"; tags = `<span class="tag-pill tag-fail">FAILED</span>`; mapColor = "#333333";
            }

            if (mapActive && isSuccess) {
                let bubbleLabel = isL2 ? tokenName : Math.floor(amt);
                let bubbleVal = amt;
                // PASS ISSUER TO BUBBLE
                bubbles.push(new Bubble(bubbleLabel, bubbleVal, mapColor, tx.hash, nameFrom||tx.Account, nameTo||tx.Destination, type, issuer));
            }

            if(watchlist.includes(tx.Account) || watchlist.includes(tx.Destination)) {
                color = "text-red-500 font-bold"; showToast("TARGET DETECTED"); mapColor = "#ff0000";
                playAlert('HVT');
            }

            // REPORT LOGIC
            if (isSuccess && (amt >= 100000 || isHVT) && !isL2) {
                const repType = getReportType(amt, isExchange);
                const outflow = getOutflow(nameFrom, nameTo);
                addReportRow(tx.hash, amt, nameFrom || tx.Account, repType, outflow);
            }

            const dispFrom = nameFrom ? `<span class="entity-name">${nameFrom}</span>` : tx.Account ? tx.Account.substring(0,4)+'...' : '???';
            const dispTo = nameTo ? `<span class="entity-name">${nameTo}</span>` : tx.Destination ? tx.Destination.substring(0,4)+'...' : 'DEX';

            const feed = document.getElementById('feed');
            if (feed.innerText.includes("AWAITING") || feed.innerText.includes("FILTER")) feed.innerHTML = "";

            const row = document.createElement('div');
            row.className = rowClass;
            let displayAmt = isL2 ? `${amt.toLocaleString()} ${tokenName} ${costDisplay}` : `${amt.toLocaleString()} XRP`;
            
            row.innerHTML = `
                <div class="row-top ${color}">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-base text-white text-shadow-lime">${displayAmt}</span>
                        ${tags}
                    </div>
                    <div class="text-[10px] font-mono text-gray-500">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="flex justify-between text-[11px] font-mono text-gray-400"><span>${dispFrom}  ${dispTo}</span></div>
                <div class="btn-row">
                    <button class="action-btn" onclick="openScan('${tx.hash}')">SCAN</button>
                    <button class="action-btn" onclick="copyHash('${tx.hash}')">COPY</button>
                    <button class="action-btn" onclick='saveCase(${JSON.stringify({hash:tx.hash, amt, from:dispFrom, to:dispTo})})'>SAVE</button>
                </div>`;
            
            feed.prepend(row);
            if(feed.children.length > 40) feed.lastChild.remove();
        }

        // --- HVT FUNCTIONS ---
        function addHVTRow(hash, amt, from, to) {
            const list = document.getElementById('hvt-list');
            if (list.innerText.includes("MONITORING")) list.innerHTML = "";
            const row = document.createElement('div');
            row.className = "p-3 border-l-4 border-yellow-400 bg-yellow-900/20 mb-2";
            row.innerHTML = `
                <div class="text-yellow-400 font-bold text-sm"> HVT INTERCEPT</div>
                <div class="text-white font-mono">${amt.toLocaleString()} XRP</div>
                <div class="text-[10px] text-gray-400 mt-1">${from} -> ${to}</div>
                <button onclick="openScan('${hash}')" class="mt-2 text-[10px] border border-yellow-600 px-2 text-yellow-500">SCAN</button>
            `;
            list.prepend(row);
        }

        function triggerWhaleAlert() {
            document.getElementById('alert-layer').classList.add('whale-alert-anim');
            setTimeout(() => document.getElementById('alert-layer').classList.remove('whale-alert-anim'), 3000);
        }

        function triggerHVTAlert() {
            document.getElementById('alert-layer').classList.add('hvt-alert-anim');
            showToast(" HVT ACTIVITY CONFIRMED ");
            setTimeout(() => document.getElementById('alert-layer').classList.remove('hvt-alert-anim'), 3000);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('toast-show');
            setTimeout(() => t.classList.remove('toast-show'), 2000);
        }
        function openScan(h) { window.open(`https://xrpscan.com/tx/${h}`, '_blank'); }
        
        function copyHash(h) {
            if (!navigator.clipboard) { fallbackCopyTextToClipboard(h); return; }
            navigator.clipboard.writeText(h).then(function() { showToast("HASH COPIED"); }, function(err) { fallbackCopyTextToClipboard(h); });
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
            document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try { var successful = document.execCommand('copy'); if(successful) showToast("HASH COPIED"); else showToast("COPY FAILED"); } catch (err) { showToast("COPY FAILED"); }
            document.body.removeChild(textArea);
        }

        function switchView(id) {
            document.querySelectorAll('.view-panel').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
            
            // Map Logic
            if(id === 'map') { mapActive = true; resizeMap(); loopMap(); } else { mapActive = false; }
        }
        function addWatch() {
            const v = document.getElementById('watch-input').value;
            if(v) { watchlist.push(v); renderWatch(); document.getElementById('watch-input').value=''; showToast("TRACKING ACTIVE"); }
        }
        function renderWatch() {
            document.getElementById('watch-list').innerHTML = watchlist.map((w,i) => `
                <div class="flex justify-between p-3 bg-green-900/20 border-b border-green-900">
                    <span class="font-mono text-xs text-green-300 truncate w-48">${w}</span>
                    <button onclick="watchlist.splice(${i},1);renderWatch()" class="text-red-500 font-bold">X</button>
                </div>`).join('');
        }
        function saveCase(d) { if(!cases.some(c=>c.hash===d.hash)) { cases.push(d); renderCases(); showToast("EVIDENCE SECURED"); } }
        function renderCases() {
            document.getElementById('case-list').innerHTML = cases.map(c => `
                <div class="p-3 border-l-2 border-yellow-500 bg-yellow-900/10 mb-1">
                    <div class="flex justify-between font-bold text-yellow-400 text-xs"><span>${(c.amt||0).toLocaleString()} ${c.token || 'XRP'}</span><span class="text-[10px] text-gray-500 font-mono">${(c.hash||'').substring(0,8)}...</span></div>
                    <div class="text-[10px] text-gray-400 mt-1">${c.from} -> ${c.to}</div>
                </div>`).join('');
        }
        function clearCases() { cases=[]; renderCases(); showToast("LOCKER CLEARED"); }
        function exportJSON() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cases));
            a.download = "sentinel_cases.json";
            a.click();
        }
        // REPORT FUNCTIONS
        function addReportRow(hash, amt, wallet, type, out) {
            const list = document.getElementById('report-list');
            if (list.innerText.includes("WAITING")) list.innerHTML = "";
            const row = document.createElement('div');
            row.className = "report-row";
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const walletDisp = wallet.startsWith('r') ? wallet.substring(0,4)+'..'+wallet.substring(wallet.length-3) : wallet.substring(0,8);
            const outColor = out === 'Y' ? 'color:#ffaa00' : (out === 'N' ? 'color:#00ffff' : 'color:#888');
            row.innerHTML = `
                <div style="width: 25%" class="rep-val-green">${(amt/1000).toFixed(1)}k</div>
                <div style="width: 25%" class="rep-val-white">${walletDisp}</div>
                <div class="rep-col-time rep-val-dim">${time}</div>
                <div class="rep-col-type text-white font-bold">${type}</div>
                <div class="rep-col-out font-bold" style="${outColor}">${out}</div>
            `;
            // Fixed: passed val: amt instead of amt: amt
            row.onclick = () => openModal({val: amt, label: (amt/1000).toFixed(1)+'k', color: '#00ff00', type: `REP-${type}`, from: wallet, to: 'LINKED', hash: hash});
            list.prepend(row);
            if (list.children.length > 50) list.lastChild.remove();
        }
        
        // Start 3D background immediately so it's ready behind video
        init3D();
    </script>
</body>
</html>