<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XRPL Checkbook | XRPMan Edition</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- XRPL.js -->
    <script src="https://unpkg.com/xrpl@2.14.0/build/xrpl-latest-min.js"></script>

    <!-- XRPMan Theme & Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            background-color: #000000;
            color: #39ff14; /* Neon Green */
            font-family: 'Rajdhani', sans-serif;
        }
        .font-mono {
            font-family: 'Share Tech Mono', monospace;
        }
        .neon-border {
            border: 1px solid #39ff14;
            box-shadow: 0 0 5px #39ff14, inset 0 0 2px #39ff14;
        }
        .neon-text {
            text-shadow: 0 0 5px #39ff14;
        }
        .hud-panel {
            background: rgba(0, 20, 0, 0.9);
            border: 1px solid #39ff14;
            position: relative;
        }
        .hud-panel::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #39ff14, transparent, #39ff14);
            z-index: -1;
            opacity: 0.3;
        }
        input, select {
            background: #050505;
            border: 1px solid #1a5c0a;
            color: #39ff14;
            outline: none;
        }
        input:focus, select:focus {
            border-color: #39ff14;
            box-shadow: 0 0 8px rgba(57, 255, 20, 0.3);
        }
        .btn-action {
            background: #000;
            border: 1px solid #39ff14;
            color: #39ff14;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-action:hover {
            background: #39ff14;
            color: #000;
            box-shadow: 0 0 15px #39ff14;
            cursor: pointer;
        }
        .btn-action:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
            background: #000;
            box-shadow: none;
        }
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #000; 
        }
        ::-webkit-scrollbar-thumb {
            background: #1a5c0a; 
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #39ff14; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            // State
            const [client, setClient] = useState(null);
            const [wallet, setWallet] = useState(null);
            const [balance, setBalance] = useState("---");
            const [network, setNetwork] = useState("wss://s.altnet.rippletest.net:51233"); // Default Testnet
            const [seed, setSeed] = useState("");
            const [status, setStatus] = useState("OFFLINE");
            const [logs, setLogs] = useState([]);
            
            // Form State
            const [destAddress, setDestAddress] = useState("");
            const [amount, setAmount] = useState("");
            const [currencyType, setCurrencyType] = useState("XRP"); // XRP or IOU
            const [iouCurrency, setIouCurrency] = useState("");
            const [iouIssuer, setIouIssuer] = useState("");
            const [memo, setMemo] = useState("");
            const [loading, setLoading] = useState(false);

            const scrollRef = useRef(null);
            const fileInputRef = useRef(null);

            // Auto-scroll logs
            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [logs]);

            // Logger helper
            const addLog = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [...prev, { time: timestamp, msg, type }]);
            };

            // Connect to XRPL
            const connect = async () => {
                if (client) {
                    await client.disconnect();
                }

                addLog(`Initializing connection to ${network}...`, 'warn');
                setStatus("CONNECTING...");
                
                try {
                    const newClient = new xrpl.Client(network);
                    await newClient.connect();
                    setClient(newClient);
                    setStatus("ONLINE");
                    addLog("Connected to XRPL Node.", 'success');
                    
                    // If wallet exists, refresh balance
                    if (wallet) {
                        fetchBalance(newClient, wallet.address);
                    }
                } catch (err) {
                    setStatus("ERROR");
                    addLog(`Connection failed: ${err.message}`, 'error');
                }
            };

            // Handle File Upload
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    setSeed(content);
                    addLog("File read successfully. Click LOAD to proceed.", "success");
                };
                reader.readAsText(file);
            };

            // Fund Wallet (Testnet)
            const fundWallet = async () => {
                if (!wallet || !client) return;
                
                addLog("Requesting funds from Testnet Faucet...", "warn");
                setLoading(true);
                
                try {
                    // Create a new wallet to just use the client capability, but request funding for OUR wallet
                    const fundResult = await client.fundWallet(wallet);
                    addLog(`Funding successful! Balance: ${fundResult.balance} XRP`, "success");
                    setBalance(fundResult.balance);
                } catch (err) {
                    addLog(`Faucet Error: ${err.message}`, "error");
                } finally {
                    setLoading(false);
                }
            };

            // Load Wallet
            const loadWallet = async () => {
                if (!seed) {
                    addLog("Please enter a valid seed.", 'error');
                    return;
                }
                
                try {
                    let walletInstance;
                    const input = seed.trim();

                    // Check if input is likely JSON
                    if (input.startsWith('{')) {
                         try {
                            const walletData = JSON.parse(input);
                            // Handle various JSON formats
                            const secret = walletData.seed || walletData.secret || walletData.privateKey || walletData.master_seed;
                            
                            if (secret) {
                                walletInstance = xrpl.Wallet.fromSeed(secret); 
                            } else if (walletData.mnemonic) {
                                walletInstance = xrpl.Wallet.fromMnemonic(walletData.mnemonic);
                            } else {
                                throw new Error("JSON must contain 'seed', 'secret', or 'mnemonic'.");
                            }
                         } catch (jsonErr) {
                             throw new Error("Invalid JSON format or missing keys. " + jsonErr.message);
                         }
                    } else {
                        // Assume standard seed string
                        walletInstance = xrpl.Wallet.fromSeed(input);
                    }

                    setWallet(walletInstance);
                    addLog(`Wallet loaded: ${walletInstance.address}`, 'success');
                    
                    if (client && client.isConnected()) {
                        fetchBalance(client, walletInstance.address);
                    } else {
                        connect();
                    }
                } catch (err) {
                    addLog(`Wallet Load Error: ${err.message}`, 'error');
                }
            };

            // Fetch Balance
            const fetchBalance = async (activeClient, address) => {
                try {
                    const bal = await activeClient.getXrpBalance(address);
                    setBalance(bal);
                    addLog(`Balance updated: ${bal} XRP`, 'info');
                } catch (err) {
                    if (err.message.includes("Account not found")) {
                        addLog("ALERT: Account not found on this network.", "error");
                        addLog("1. If using Mainnet account, switch to MAINNET (top right).", "warn");
                        addLog("2. If testing, click FUND (TESTNET) below.", "warn");
                        setBalance("UNFUNDED");
                    } else {
                        addLog(`Could not fetch balance: ${err.message}`, 'warn');
                        setBalance("ERR");
                    }
                }
            };

            // Handle Network Change
            const toggleNetwork = (e) => {
                const newNet = e.target.value;
                setNetwork(newNet);
                // Disconnect current client to force reconnect on next action or manually
                if(client) client.disconnect();
                setClient(null);
                setStatus("OFFLINE");
                addLog(`Switched network endpoint to ${newNet}. Please Reconnect.`, 'warn');
            };

            // SEND CHECK
            const writeCheck = async () => {
                if (!client || !client.isConnected()) {
                    addLog("Client not connected. Reconnecting...", 'warn');
                    await connect();
                    return;
                }
                if (!wallet) {
                    addLog("No wallet loaded.", 'error');
                    return;
                }

                setLoading(true);
                addLog(`Preparing Check for ${amount} ${currencyType === 'XRP' ? 'XRP' : iouCurrency}...`);

                try {
                    // 1. Construct Amount
                    let sendMax;
                    if (currencyType === 'XRP') {
                        sendMax = xrpl.xrpToDrops(amount);
                    } else {
                        sendMax = {
                            currency: iouCurrency,
                            issuer: iouIssuer,
                            value: amount
                        };
                    }

                    // 2. Prepare Transaction
                    const tx = {
                        TransactionType: "CheckCreate",
                        Account: wallet.address,
                        Destination: destAddress,
                        SendMax: sendMax
                    };

                    // Add Memo if present
                    if (memo) {
                        try {
                            const hexMemo = xrpl.convertStringToHex(memo);
                            tx.Memos = [{
                                Memo: {
                                    MemoData: hexMemo
                                }
                            }];
                        } catch (e) {
                            console.error("Memo encoding error:", e);
                            addLog("Error encoding memo. Sending without memo.", 'warn');
                        }
                    }

                    // 3. Submit
                    addLog("Signing and submitting transaction...", 'warn');
                    const result = await client.submitAndWait(tx, { wallet });

                    // 4. Handle Result
                    const resultParams = result.result;
                    if (resultParams.meta.TransactionResult === "tesSUCCESS") {
                        addLog(`Check Created Successfully!`, 'success');
                        addLog(`Tx Hash: ${resultParams.hash}`, 'success');
                        addLog(`Note: Recipient can now see this check. Trustline not required to SEND, but required to CASH (if IOU).`, 'info');
                        fetchBalance(client, wallet.address);
                    } else {
                        addLog(`Transaction Failed: ${resultParams.meta.TransactionResult}`, 'error');
                    }

                } catch (err) {
                    if (err.message.includes("Account not found")) {
                        addLog("ERROR: Account not found on ledger.", "error");
                        addLog("TIP: Are you on the correct network (Testnet/Mainnet)?", "warn");
                    } else {
                        addLog(`Error writing check: ${err.message}`, 'error');
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center">
                    
                    {/* HEADER */}
                    <header className="w-full max-w-4xl mb-8 flex justify-between items-center border-b border-[#39ff14] pb-4">
                        <div>
                            <h1 className="text-4xl font-bold neon-text tracking-tighter">XRPL CHECKBOOK</h1>
                            <p className="text-xs text-[#39ff14] opacity-70 font-mono mt-1">NO TRUSTLINE REQUIRED TO SEND</p>
                        </div>
                        <div className="text-right font-mono text-sm">
                            <div className="flex items-center gap-2 justify-end">
                                <span className={`w-2 h-2 rounded-full ${status === 'ONLINE' ? 'bg-[#39ff14] animate-pulse' : 'bg-red-500'}`}></span>
                                {status}
                            </div>
                            <select 
                                value={network} 
                                onChange={toggleNetwork}
                                className="mt-2 text-xs p-1"
                            >
                                <option value="wss://s.altnet.rippletest.net:51233">TESTNET</option>
                                <option value="wss://xrplcluster.com">MAINNET</option>
                            </select>
                        </div>
                    </header>

                    <main className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8">
                        
                        {/* LEFT COLUMN: WALLET & ACTIONS */}
                        <div className="space-y-6">
                            
                            {/* Wallet Loader */}
                            <div className="hud-panel p-6 rounded-lg">
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    <svg className="w-5 h-5 text-[#39ff14]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                    ACCESS PORT
                                </h2>
                                
                                {!wallet ? (
                                    <div className="space-y-4">
                                        <input 
                                            type="file" 
                                            ref={fileInputRef} 
                                            onChange={handleFileChange} 
                                            accept=".json" 
                                            style={{display: 'none'}} 
                                        />
                                        <button 
                                            onClick={() => fileInputRef.current.click()}
                                            className="w-full mb-2 border border-[#39ff14] text-[#39ff14] bg-transparent hover:bg-[#39ff14] hover:text-black p-2 text-xs font-bold uppercase transition border-dashed"
                                        >
                                            ðŸ“‚ Open Wallet JSON File
                                        </button>

                                        <textarea 
                                            placeholder="ENTER SEED (s...) OR PASTE WALLET JSON" 
                                            className="w-full p-3 font-mono text-sm bg-black focus:bg-[#0a0a0a] min-h-[80px]"
                                            value={seed}
                                            onChange={(e) => setSeed(e.target.value)}
                                        />
                                        <button 
                                            onClick={loadWallet}
                                            className="w-full btn-action p-3"
                                        >
                                            LOAD WALLET INTERFACE
                                        </button>
                                        <p className="text-[10px] text-gray-500 mt-2 text-center">
                                            KEYS PROCESSED LOCALLY. SUPPORTS SEED STRINGS OR JSON OBJECTS.
                                        </p>
                                    </div>
                                ) : (
                                    <div className="font-mono text-sm space-y-2">
                                        <div className="flex justify-between border-b border-[#1a5c0a] pb-2">
                                            <span className="opacity-50">ADDRESS</span>
                                            <span className="text-[#39ff14] break-all text-right ml-4">{wallet.address}</span>
                                        </div>
                                        <div className="flex justify-between pt-2">
                                            <span className="opacity-50">BALANCE</span>
                                            <span className={`text-xl font-bold ${balance === "UNFUNDED" ? "text-red-500" : ""}`}>{balance} XRP</span>
                                        </div>
                                        
                                        {balance === "UNFUNDED" && network.includes("altnet") && (
                                            <button 
                                                onClick={fundWallet}
                                                disabled={loading}
                                                className="w-full border border-yellow-500 text-yellow-500 text-xs p-2 hover:bg-yellow-900 hover:text-white transition mt-2 animate-pulse"
                                            >
                                                {loading ? "REQUESTING..." : "âš¡ FUND (TESTNET FAUCET)"}
                                            </button>
                                        )}

                                        <button 
                                            onClick={() => { setWallet(null); setSeed(""); setBalance("---"); }}
                                            className="mt-4 w-full border border-red-900 text-red-500 text-xs p-2 hover:bg-red-900 hover:text-white transition"
                                        >
                                            DISCONNECT WALLET
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Check Writer */}
                            <div className={`hud-panel p-6 rounded-lg transition-opacity duration-500 ${!wallet ? 'opacity-50 pointer-events-none grayscale' : 'opacity-100'}`}>
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    <svg className="w-5 h-5 text-[#39ff14]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                    WRITE CHECK
                                </h2>

                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs font-mono opacity-70 mb-1 block">PAY TO THE ORDER OF</label>
                                        <input 
                                            type="text" 
                                            placeholder="DESTINATION ADDRESS (r...)" 
                                            className="w-full p-2 font-mono text-sm"
                                            value={destAddress}
                                            onChange={(e) => setDestAddress(e.target.value)}
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-mono opacity-70 mb-1 block">AMOUNT</label>
                                            <input 
                                                type="number" 
                                                placeholder="0.00" 
                                                className="w-full p-2 font-mono text-sm"
                                                value={amount}
                                                onChange={(e) => setAmount(e.target.value)}
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs font-mono opacity-70 mb-1 block">ASSET TYPE</label>
                                            <select 
                                                className="w-full p-2 font-mono text-sm h-[38px]"
                                                value={currencyType}
                                                onChange={(e) => setCurrencyType(e.target.value)}
                                            >
                                                <option value="XRP">XRP (Native)</option>
                                                <option value="IOU">ISSUED ASSET</option>
                                            </select>
                                        </div>
                                    </div>

                                    {currencyType === 'IOU' && (
                                        <div className="p-3 border border-[#1a5c0a] bg-black/50 space-y-3 animate-fadeIn">
                                            <div>
                                                <label className="text-[10px] font-mono opacity-70 block">CURRENCY CODE (e.g. USD, BTC)</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full p-1 text-sm font-mono bg-transparent border-b border-[#39ff14] focus:border-white outline-none"
                                                    value={iouCurrency}
                                                    onChange={(e) => setIouCurrency(e.target.value.toUpperCase())}
                                                />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-mono opacity-70 block">ISSUER ADDRESS (r...)</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full p-1 text-sm font-mono bg-transparent border-b border-[#39ff14] focus:border-white outline-none"
                                                    value={iouIssuer}
                                                    onChange={(e) => setIouIssuer(e.target.value)}
                                                />
                                            </div>
                                        </div>
                                    )}

                                    {/* Memo Field */}
                                    <div>
                                        <label className="text-xs font-mono opacity-70 mb-1 block">MEMO (OPTIONAL)</label>
                                        <input 
                                            type="text" 
                                            placeholder="ADD A NOTE / REFERENCE..." 
                                            className="w-full p-2 font-mono text-sm"
                                            value={memo}
                                            onChange={(e) => setMemo(e.target.value)}
                                        />
                                    </div>

                                    <div className="pt-2">
                                        <button 
                                            onClick={writeCheck}
                                            disabled={loading}
                                            className="w-full btn-action p-4 text-lg tracking-widest flex justify-center items-center gap-2"
                                        >
                                            {loading ? (
                                                <span className="animate-spin h-5 w-5 border-2 border-[#39ff14] border-t-transparent rounded-full"></span>
                                            ) : (
                                                "SIGN & DELIVER CHECK"
                                            )}
                                        </button>
                                    </div>
                                    
                                    <div className="text-[10px] text-gray-400 p-2 border border-[#1a5c0a] bg-black">
                                        <strong className="text-[#39ff14]">NOTE:</strong> If sending an Issued Asset (non-XRP), the recipient can receive this Check even without a Trustline. They will need to add the Trustline only when they attempt to Cash it.
                                    </div>
                                </div>
                            </div>

                        </div>

                        {/* RIGHT COLUMN: LOGS */}
                        <div className="flex flex-col h-full min-h-[400px]">
                            <div className="hud-panel flex-1 p-4 rounded-lg flex flex-col h-full">
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2 border-b border-[#1a5c0a] pb-2">
                                    <svg className="w-5 h-5 text-[#39ff14]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    TRANSACTION LOG
                                </h2>
                                
                                <div 
                                    ref={scrollRef}
                                    className="flex-1 overflow-y-auto font-mono text-xs space-y-2 pr-2"
                                >
                                    {logs.length === 0 && <span className="opacity-30 italic">System ready. Waiting for input...</span>}
                                    
                                    {logs.map((log, idx) => (
                                        <div key={idx} className={`p-2 border-l-2 ${
                                            log.type === 'error' ? 'border-red-500 bg-red-900/20 text-red-400' : 
                                            log.type === 'success' ? 'border-[#39ff14] bg-[#39ff14]/10 text-[#39ff14]' : 
                                            log.type === 'warn' ? 'border-yellow-500 bg-yellow-900/20 text-yellow-400' :
                                            'border-gray-500 text-gray-300'
                                        }`}>
                                            <span className="opacity-50 mr-2">[{log.time}]</span>
                                            <span className="break-all">{log.msg}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                    </main>
                    
                    <footer className="mt-12 text-center opacity-40 text-xs font-mono">
                        XRPL CHECKBOOK v1.0 | SECURED BY XRPL.JS | XRPMAN 2025
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


