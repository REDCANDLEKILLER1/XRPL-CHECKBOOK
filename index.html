<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XRPL Checkbook | XRPMan Edition</title>
    <link rel="icon" href="data:,">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xrpl@2.14.0/build/xrpl-latest-min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* APP SHELL SETUP */
        html, body, #root {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
            background-color: #000000;
            color: #39ff14;
            font-family: 'Rajdhani', sans-serif;
            background-image: radial-gradient(circle at center, #0a1f0a 0%, #000000 70%);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .font-mono { font-family: 'Share Tech Mono', monospace; }

        /* UI ELEMENTS */
        .hud-panel {
            background: rgba(0, 20, 0, 0.95);
            border: 1px solid #39ff14;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.1);
        }
        
        input, select, textarea {
            background: #050505;
            border: 1px solid #1a5c0a;
            color: #39ff14;
            outline: none;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #39ff14;
            box-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
        }

        .btn-action {
            background: #000;
            border: 1px solid #39ff14;
            color: #39ff14;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.1s;
        }
        .btn-action:active { transform: scale(0.98); }
        .btn-action:disabled { border-color: #555; color: #555; cursor: not-allowed; }

        /* AI BUTTONS */
        .btn-ai {
            background: linear-gradient(135deg, #1a5c0a 0%, #000000 100%);
            border: 1px solid #a855f7; /* Purple border for AI */
            color: #d8b4fe; /* Light purple text */
            text-shadow: 0 0 5px rgba(168, 85, 247, 0.5);
            transition: all 0.3s ease;
        }
        .btn-ai:hover {
            background: linear-gradient(135deg, #2e1065 0%, #000000 100%);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
            border-color: #d8b4fe;
        }

        /* ANIMATIONS */
        .glow-pulse { animation: glowPulse 2s infinite; }
        @keyframes glowPulse {
            0% { text-shadow: 0 0 5px #39ff14; opacity: 0.8; }
            50% { text-shadow: 0 0 15px #39ff14; opacity: 1; }
            100% { text-shadow: 0 0 5px #39ff14; opacity: 0.8; }
        }

        /* TEXT NEON PULSE */
        .text-neon-pulse { animation: textNeonPulse 1.5s infinite alternate; }
        @keyframes textNeonPulse {
            0% { text-shadow: 0 0 10px #39ff14, 0 0 20px #39ff14; opacity: 0.9; transform: scale(1); }
            100% { text-shadow: 0 0 20px #39ff14, 0 0 30px #39ff14, 0 0 40px #39ff14; opacity: 1; transform: scale(1.02); }
        }

        /* ENERGY FLICKER */
        .energy-flicker { animation: energyFlicker 3s infinite; }
        @keyframes energyFlicker {
            0%, 100% { opacity: 0.7; text-shadow: 0 0 5px #39ff14; }
            50% { opacity: 1; text-shadow: 0 0 15px #39ff14, 0 0 20px #39ff14; }
            52% { opacity: 0.8; text-shadow: 0 0 5px #39ff14; }
            54% { opacity: 1; text-shadow: 0 0 15px #39ff14; }
        }

        /* CUSTOM SCROLLBAR */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #000; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #1a5c0a; }

        /* TAB STYLING */
        .tab-btn {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.7rem;
            text-transform: uppercase;
            border-top: 2px solid transparent;
            opacity: 0.6;
            transition: all 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .tab-btn.active {
            border-top-color: #39ff14;
            color: #39ff14;
            background: rgba(57, 255, 20, 0.05);
            opacity: 1;
            text-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
        }

        /* BACKGROUND */
        .floating-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        .xrp-logo {
            position: absolute; opacity: 0.15; color: #39ff14;
            animation: floatMove linear infinite;
        }
        @keyframes floatMove {
            0% { transform: translateY(110vh) rotate(0deg) scale(0.8); opacity: 0; }
            20% { opacity: 0.15; }
            80% { opacity: 0.15; }
            100% { transform: translateY(-10vh) rotate(360deg) scale(1.2); opacity: 0; }
        }

        /* MODAL OVERLAY */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            z-index: 100;
            display: flex; justify-content: center; items-center;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DYNAMIC TOUR STYLES */
        .tour-spotlight-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 999;
            pointer-events: auto;
        }
        .tour-highlight-box {
            position: absolute;
            border: 2px solid #39ff14;
            box-shadow: 0 0 20px #39ff14, inset 0 0 10px #39ff14;
            transition: all 0.3s ease-out;
            pointer-events: none; /* Let clicks pass through if needed, but usually we intercept */
            background: transparent;
            z-index: 1000;
            animation: pulseBorder 1.5s infinite;
        }
        @keyframes pulseBorder {
            0% { border-color: #39ff14; box-shadow: 0 0 15px #39ff14; }
            50% { border-color: #fff; box-shadow: 0 0 30px #39ff14; }
            100% { border-color: #39ff14; box-shadow: 0 0 15px #39ff14; }
        }
        .tour-tooltip {
            position: absolute;
            background: black;
            border: 1px solid #39ff14;
            padding: 15px;
            width: 280px;
            z-index: 1001;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
            transition: all 0.3s ease-out;
        }
        .tour-tooltip h4 { color: #39ff14; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .tour-tooltip p { font-size: 12px; color: white; line-height: 1.4; margin-bottom: 15px; font-family: monospace; }
        
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        // --- CONFIGURATION ---
        const SERVICE_WALLET = "r9nepSD5tvQUCA4qQAJJDAoBB3j1gf4ibL";
        const SERVICE_FEE = "0.00001"; 

        // --- GEMINI AI HELPER (ENV KEY ONLY) ---
        const callGemini = async (prompt, systemInstruction = "") => {
            const apiKey = ""; // Runtime provided by environment

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`AI API Error: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "No response generated.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        };

        // --- TOUR DATA WITH SELECTORS ---
        const LOGIN_TOUR_STEPS = [
            {
                selector: "#login-header",
                title: "Welcome to Checkbook",
                text: "The ultimate tool for deferred payments and payroll on the XRPL. Let's get you set up."
            },
            {
                selector: "#login-import-btn",
                title: "Existing Users",
                text: "Already have a key? Click 'Import JSON' to load your saved file instantly."
            },
            {
                selector: "#secret-input",
                title: "Manual Entry",
                text: "Or paste your Secret (s...) or Mnemonic words directly here to connect."
            },
            {
                selector: "#login-create-btn",
                title: "New Identity",
                text: "New here? Use this button to generate a secure 12/24 word phrase or seed."
            }
        ];

        const APP_TOUR_STEPS = [
            {
                selector: "header", // Use tag name or class if ID missing
                title: "Command Center",
                text: "You are online. Check your Balance here. Tap the address to switch between multiple wallets.",
                tab: "WRITE"
            },
            {
                selector: "#batch-btn",
                title: "Batch Payroll Mode",
                text: "Sending Airdrops or Payroll? Click here to switch to CSV mode and pay multiple people at once.",
                tab: "WRITE"
            },
            {
                selector: "#currency-select",
                title: "Asset Selection",
                text: "Use the dropdown to switch between XRP and Layer 2 Tokens (IOUs) for your checks.",
                tab: "WRITE"
            },
            {
                selector: "#nav-manage",
                title: "Liquidity Control",
                text: "Go to MANAGE to see sent checks. You can VOID any uncashed check to instantly reclaim funds.",
                tab: "MANAGE"
            },
            {
                selector: "#nav-inbox",
                title: "Receiving Funds",
                text: "The INBOX scans the ledger for checks sent TO you. Just click 'CASH' to deposit them.",
                tab: "INBOX"
            }
        ];

        /* --- AUDIO SYSTEM --- */
        const useSound = () => {
            const audioCtx = useRef(null);
            const initAudio = () => {
                if (!audioCtx.current) audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.current.state === 'suspended') audioCtx.current.resume();
            };
            const playTone = (freq, type, duration, volume = 0.05) => {
                initAudio();
                const ctx = audioCtx.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type; 
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                gain.gain.setValueAtTime(volume, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + duration);
            };
            return {
                click: () => playTone(1200, 'sine', 0.1),
                success: () => { playTone(440, 'sine', 0.1); setTimeout(() => playTone(880, 'triangle', 0.2), 100); },
                error: () => playTone(150, 'sawtooth', 0.3),
                magic: () => {
                    initAudio();
                    const now = audioCtx.current.currentTime;
                    const osc = audioCtx.current.createOscillator();
                    const gain = audioCtx.current.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(500, now);
                    osc.frequency.linearRampToValueAtTime(1000, now + 0.3);
                    osc.frequency.linearRampToValueAtTime(1500, now + 0.6);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                    osc.connect(gain); gain.connect(audioCtx.current.destination);
                    osc.start(now); osc.stop(now + 0.8);
                },
                modernLogin: () => {
                    initAudio();
                    const now = audioCtx.current.currentTime;
                    const osc1 = audioCtx.current.createOscillator();
                    const g1 = audioCtx.current.createGain();
                    osc1.frequency.setValueAtTime(110, now);
                    osc1.frequency.exponentialRampToValueAtTime(440, now + 0.6);
                    g1.gain.setValueAtTime(0, now);
                    g1.gain.linearRampToValueAtTime(0.3, now + 0.1);
                    g1.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                    osc1.connect(g1); g1.connect(audioCtx.current.destination);
                    osc1.start(now); osc1.stop(now + 0.8);
                },
                powerup: () => {
                    playTone(392.00, 'square', 0.1, 0.1); setTimeout(() => playTone(587.33, 'square', 0.1, 0.1), 120);
                }
            };
        };

        /* --- BACKGROUND --- */
        const MovingBackground = () => {
            return (
                <div className="floating-bg">
                    {[...Array(12)].map((_, i) => (
                        <div key={i} className="xrp-logo" style={{ 
                            left: Math.random() * 100 + '%', 
                            width: Math.random() * 50 + 30 + 'px', 
                            height: Math.random() * 50 + 30 + 'px',
                            animationDuration: Math.random() * 25 + 15 + 's', 
                            animationDelay: Math.random() * 20 + 's' 
                        }}>
                            <svg viewBox="0 0 24 24" fill="currentColor" className="w-full h-full">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.65 14.65L12 12l-4.65 4.65-1.41-1.41L10.59 10.59 5.94 5.94l1.41-1.41L12 9.17l4.65-4.65 1.41 1.41L13.41 10.59l4.65 4.65-1.41 1.41z"/>
                            </svg>
                        </div>
                    ))}
                </div>
            );
        };

        /* --- MAIN APP --- */
        function App() {
            const sound = useSound();
            const [client, setClient] = useState(null);
            
            // Wallet State
            const [wallet, setWallet] = useState(null); 
            const [allWallets, setAllWallets] = useState([]); 
            const [balance, setBalance] = useState("---");
            
            const [network] = useState("wss://xrplcluster.com");
            const [seed, setSeed] = useState("");
            const [logs, setLogs] = useState([]);
            
            // View State
            const [activeTab, setActiveTab] = useState('WRITE');
            const [isBatchMode, setIsBatchMode] = useState(false);
            const [loading, setLoading] = useState(false);
            
            // Modals & Tools
            const [confirmModal, setConfirmModal] = useState(null); 
            const [newWalletData, setNewWalletData] = useState(null);
            const [showAccountSwitcher, setShowAccountSwitcher] = useState(false);
            const [showAddWalletModal, setShowAddWalletModal] = useState(false);
            const [showSmartImportModal, setShowSmartImportModal] = useState(false);
            const [smartImportText, setSmartImportText] = useState("");
            const [aiProcessing, setAiProcessing] = useState(false);
            
            // Tour State
            const [tourType, setTourType] = useState(null); // 'login' | 'app' | null
            const [tourStep, setTourStep] = useState(0);
            const [highlightRect, setHighlightRect] = useState(null);

            // Generate Mode
            const [genType, setGenType] = useState(null); 

            // Forms
            const [destAddress, setDestAddress] = useState("");
            const [amount, setAmount] = useState("");
            const [currencyType, setCurrencyType] = useState("XRP");
            const [iouCurrency, setIouCurrency] = useState("");
            const [iouIssuer, setIouIssuer] = useState("");
            const [memo, setMemo] = useState("");
            const [batchList, setBatchList] = useState("");
            const [activeChecks, setActiveChecks] = useState([]);
            const [incomingChecks, setIncomingChecks] = useState([]);
            
            // Wallet Data
            const [trustlines, setTrustlines] = useState([]);
            const [paymentDest, setPaymentDest] = useState("");
            const [paymentAmount, setPaymentAmount] = useState("");
            const [payAssetIdx, setPayAssetIdx] = useState("XRP");
            const [contacts, setContacts] = useState({});
            const [showContacts, setShowContacts] = useState(false);
            const [newContactName, setNewContactName] = useState("");

            const fileInputRef = useRef(null);
            const logEndRef = useRef(null);

            useEffect(() => {
                const saved = localStorage.getItem('xrpl_address_book');
                if (saved) { try { setContacts(JSON.parse(saved) || {}); } catch (e) {} }
            }, []);

            useEffect(() => { logEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [logs]);

            // Define derived state for modal
            const checkDetails = confirmModal && confirmModal.type === 'CASH' 
                ? incomingChecks.find(c => c.id === confirmModal.id) 
                : null;

            // Define missing handlers
            const handleAssetSelect = (e) => {
                const idx = e.target.value;
                if (idx !== "" && trustlines[idx]) {
                    const asset = trustlines[idx];
                    setIouCurrency(asset.currency);
                    setIouIssuer(asset.account);
                }
            };

            const saveContact = () => {
                if(!newContactName || !destAddress) return;
                const newContacts = {...contacts, [newContactName]: destAddress};
                setContacts(newContacts);
                localStorage.setItem('xrpl_address_book', JSON.stringify(newContacts));
                setNewContactName("");
                sound.success();
            };

            const renderContacts = () => (
                <div className="absolute top-full left-0 w-full bg-black border border-[#39ff14] z-50 p-2 shadow-xl animate-fadeIn mt-1">
                     <div className="flex gap-1 mb-2">
                        <input className="flex-1 p-1 text-xs bg-[#050505] border border-[#1a5c0a] text-[#39ff14]" placeholder="Save address as..." value={newContactName} onChange={e=>setNewContactName(e.target.value)} />
                        <button onClick={saveContact} className="text-[10px] bg-[#39ff14] text-black px-2 font-bold hover:bg-white">SAVE</button>
                     </div>
                     <div className="max-h-32 overflow-y-auto custom-scroll space-y-1">
                        {Object.entries(contacts).map(([name, addr]) => (
                            <div key={name} className="flex justify-between items-center text-xs p-1 hover:bg-[#1a5c0a] cursor-pointer border-b border-gray-800 last:border-0" onClick={()=>{setDestAddress(addr); setShowContacts(false);}}>
                                <span className="font-bold text-[#39ff14]">{name}</span>
                                <span className="opacity-50 text-[10px] font-mono">{addr.substring(0,8)}...</span>
                            </div>
                        ))}
                        {Object.keys(contacts).length === 0 && <div className="text-[10px] text-center opacity-50 py-2">No saved contacts</div>}
                     </div>
                     <div className="text-center mt-2 border-t border-gray-800 pt-1">
                        <button onClick={()=>setShowContacts(false)} className="text-[10px] text-gray-500 hover:text-white">CLOSE</button>
                     </div>
                </div>
            );

            // --- TOUR ENGINE ---
            useEffect(() => {
                if (!wallet && !localStorage.getItem('xrpl_login_tour_seen')) {
                    setTimeout(() => { setTourType('login'); setTourStep(0); }, 1000);
                }
            }, [wallet]);

            const triggerAppTour = () => {
                 if (!localStorage.getItem('xrpl_app_tour_seen')) {
                     setTourType('app');
                     setTourStep(0);
                 }
            };

            const nextTourStep = () => {
                sound.click();
                const currentSteps = tourType === 'login' ? LOGIN_TOUR_STEPS : APP_TOUR_STEPS;
                if (tourStep < currentSteps.length - 1) {
                    setTourStep(tourStep + 1);
                } else {
                    if(tourType === 'login') localStorage.setItem('xrpl_login_tour_seen', 'true');
                    if(tourType === 'app') localStorage.setItem('xrpl_app_tour_seen', 'true');
                    setTourType(null);
                    setTourStep(0);
                    setHighlightRect(null);
                }
            };

            useEffect(() => {
                if (tourType) {
                    const currentSteps = tourType === 'login' ? LOGIN_TOUR_STEPS : APP_TOUR_STEPS;
                    const step = currentSteps[tourStep];
                    if (!step) return;

                    // 1. Force Tab Switch if needed
                    if (step.tab && activeTab !== step.tab) {
                        setActiveTab(step.tab);
                    }

                    // 2. Find Element and Calculate Rect (Delayed to allow render)
                    setTimeout(() => {
                        const el = document.querySelector(step.selector);
                        if (el) {
                            const rect = el.getBoundingClientRect();
                            setHighlightRect({
                                top: rect.top + window.scrollY,
                                left: rect.left + window.scrollX,
                                width: rect.width,
                                height: rect.height
                            });
                            // Scroll if off screen
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            // Fallback if element not found (center screen)
                            setHighlightRect(null); 
                        }
                    }, 150);
                } else {
                    setHighlightRect(null);
                }
            }, [tourStep, tourType, activeTab]);


            const addLog = (msg, type='info') => {
                setLogs(p => [...p, { time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}), msg, type }]);
                if(type === 'error') sound.error();
            };

            const copyToClipboard = (text) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => { sound.success(); addLog("Copied.", "success"); }).catch(err => fallbackCopy(text));
                } else { fallbackCopy(text); }
            };

            const fallbackCopy = (text) => {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
                    document.body.appendChild(textArea); textArea.focus(); textArea.select();
                    const successful = document.execCommand('copy'); document.body.removeChild(textArea);
                    if (successful) { sound.success(); addLog("Copied (Legacy).", "success"); } else throw new Error("Copy failed");
                } catch (err) { sound.error(); addLog("Copy Failed", "error"); }
            };

            const decodeCurrency = (c) => {
                if (!c) return ""; if (c.length === 3) return c;
                if (c.length === 40) { try { return xrpl.convertHexToString(c).replace(/\0/g, '') || c.substring(0,4)+"..."; } catch(e) { return c.substring(0,4)+"..."; } }
                return c;
            };

            const fetchBalanceForWallet = async (cl, wObj) => {
                try { return await cl.getXrpBalance(wObj.address); } catch (err) { if (err.message.includes("Account not found")) return "0 (INACTIVE)"; return "Err"; }
            };

            const activateWallet = async (wInstance, cl = client) => {
                setLoading(true);
                try {
                    let activeClient = cl;
                    if (!activeClient || !activeClient.isConnected()) {
                        activeClient = new xrpl.Client(network); await activeClient.connect(); setClient(activeClient);
                    }
                    const bal = await fetchBalanceForWallet(activeClient, wInstance);
                    setWallet(wInstance); setBalance(bal);
                    setAllWallets(prev => {
                        const exists = prev.find(x => x.wallet.address === wInstance.address);
                        if(exists) return prev.map(x => x.wallet.address === wInstance.address ? { ...x, balance: bal } : x);
                        return [...prev, { wallet: wInstance, balance: bal }];
                    });
                    setTrustlines([]); setActiveChecks([]); setIncomingChecks([]);
                    sound.modernLogin(); addLog(`Active: ${wInstance.address.substring(0,8)}...`, "success");
                    setTimeout(triggerAppTour, 500); // Trigger tour after login
                } catch (e) { addLog("Error: " + e.message, "error"); } finally { setLoading(false); setShowAddWalletModal(false); setShowAccountSwitcher(false); setGenType(null); }
            };

            const loadWalletFromInput = () => {
                sound.click();
                const input = seed.trim();
                if (!input) return addLog("Enter Key", "error");
                try {
                    let w;
                    if (input.startsWith('{')) {
                        const d = JSON.parse(input);
                        const key = d.seed || d.secret || d.privateKey || d.mnemonic || d.master_seed;
                        if (!key) throw new Error("No valid key");
                        if (key.includes(' ')) w = xrpl.Wallet.fromMnemonic(key); else w = xrpl.Wallet.fromSeed(key);
                    } else if (input.includes(' ')) {
                        w = xrpl.Wallet.fromMnemonic(input.split(/[\s\n]+/).filter(x => x).join(' '));
                    } else { w = xrpl.Wallet.fromSeed(input); }
                    if(w) activateWallet(w);
                } catch (e) { addLog("Invalid Key", "error"); }
            };

            const generateNewWallet = (type) => {
                sound.click();
                try {
                    let newWallet, secretDisplay;
                    if (type === 'seed') { newWallet = xrpl.Wallet.generate(); secretDisplay = newWallet.seed; }
                    else if (type === 'seed_ed') { newWallet = xrpl.Wallet.generate('ed25519'); secretDisplay = newWallet.seed; }
                    else if (type === '12' || type === '24') {
                        if (!window.ethers) throw new Error("Library loading...");
                        const entropy = ethers.utils.randomBytes(type === '12' ? 16 : 32);
                        const mnemonic = ethers.utils.entropyToMnemonic(entropy);
                        newWallet = xrpl.Wallet.fromMnemonic(mnemonic); secretDisplay = mnemonic;
                    }
                    setNewWalletData({ address: newWallet.classicAddress, seed: secretDisplay, type: type });
                    sound.powerup(); setGenType(null);
                } catch (e) { addLog("Error: " + e.message, "error"); }
            };

            const downloadJSON = () => {
                if (!newWalletData) return;
                try {
                    const dataStr = JSON.stringify(newWalletData, null, 2);
                    const blob = new Blob([dataStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `xrpl_wallet_${newWalletData.address}.json`;
                    document.body.appendChild(a); a.click();
                    setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
                    sound.success(); addLog("Downloaded.", "success");
                } catch (e) { addLog("Download Error", "error"); }
            };

            const removeWallet = (address) => {
                if(!confirm("Remove session?")) return;
                const newAll = allWallets.filter(x => x.wallet.address !== address); setAllWallets(newAll);
                if (wallet && wallet.address === address) { if (newAll.length > 0) activateWallet(newAll[0].wallet, client); else { setWallet(null); setBalance("---"); } }
            };

            const payServiceFee = async () => {
                try { await client.submit({ TransactionType: "Payment", Account: wallet.address, Destination: SERVICE_WALLET, Amount: xrpl.xrpToDrops(SERVICE_FEE) }, { wallet }); } catch(e) {}
            };

            const fetchChecks = async () => {
                if(!client || !wallet) return; setLoading(true);
                try { const res = await client.request({ command: "account_objects", account: wallet.address, type: "check" }); setActiveChecks(res.result.account_objects); sound.success(); } catch(e) { addLog(e.message, "error"); } setLoading(false);
            };

            const fetchIncomingChecks = async () => {
                if(!client || !wallet) return; setLoading(true); addLog("Scanning...", "info");
                try {
                    const res = await client.request({ command: "account_tx", account: wallet.address, limit: 200 });
                    const potentialChecks = [];
                    res.result.transactions.forEach(t => {
                        const tx = t.tx;
                        if (tx.TransactionType === 'CheckCreate' && tx.Destination === wallet.address) {
                            let checkId = null;
                            t.meta.AffectedNodes.forEach(node => { if (node.CreatedNode && node.CreatedNode.LedgerEntryType === 'Check') checkId = node.CreatedNode.LedgerIndex; });
                            if (checkId) potentialChecks.push({ id: checkId, sender: tx.Account, amount: tx.SendMax });
                        }
                    });
                    if (potentialChecks.length === 0) { addLog("No checks.", "warn"); setIncomingChecks([]); setLoading(false); return; }
                    const activeIncoming = [];
                    for (let c of potentialChecks) { try { await client.request({ command: "ledger_entry", index: c.id }); activeIncoming.push(c); } catch (e) {} }
                    setIncomingChecks(activeIncoming); if(activeIncoming.length > 0) sound.success();
                } catch(e) {} finally { setLoading(false); }
            };

            const fetchTrustlines = async () => {
                if(!client || !wallet) return; setLoading(true);
                try { const res = await client.request({ command: "account_lines", account: wallet.address }); setTrustlines(res.result.lines); sound.success(); } catch(e) { addLog(e.message, "error"); } setLoading(false);
            };

            const requestAction = (id, type) => { sound.alert(); if (!id) return; setConfirmModal({ id, type }); };

            const executeVoid = async () => {
                sound.click(); if(!client || !wallet || !confirmModal) return;
                const idToVoid = confirmModal.id; setLoading(true);
                try {
                    const res = await client.submitAndWait({ TransactionType: "CheckCancel", Account: wallet.address, CheckID: idToVoid }, { wallet });
                    if(res.result.meta.TransactionResult === "tesSUCCESS") { addLog("Void Success", "success"); sound.powerup(); fetchChecks(); const bal = await client.getXrpBalance(wallet.address); setBalance(bal); setConfirmModal(null); }
                    else { addLog("Void Failed", "error"); setConfirmModal(null); }
                } catch(e) { addLog(e.message, "error"); setConfirmModal(null); } finally { setLoading(false); }
            };

            const executeCash = async () => {
                sound.click(); if(!client || !wallet || !confirmModal) return;
                const idToCash = confirmModal.id; const checkObj = incomingChecks.find(c => c.id === idToCash); if (!checkObj) return;
                setLoading(true);
                try {
                    const res = await client.submitAndWait({ TransactionType: "CheckCash", Account: wallet.address, CheckID: idToCash, Amount: checkObj.amount }, { wallet });
                    if(res.result.meta.TransactionResult === "tesSUCCESS") { addLog("Cash Success", "success"); sound.powerup(); fetchIncomingChecks(); const bal = await client.getXrpBalance(wallet.address); setBalance(bal); setConfirmModal(null); }
                    else { addLog("Cash Failed", "error"); setConfirmModal(null); }
                } catch(e) { addLog(e.message, "error"); setConfirmModal(null); } finally { setLoading(false); }
            };

            const sendCheck = async () => {
                sound.click(); if(!client) return; setLoading(true);
                try {
                    let sendMax = currencyType === 'XRP' ? xrpl.xrpToDrops(amount) : { currency: iouCurrency, issuer: iouIssuer, value: amount };
                    const tx = { TransactionType: "CheckCreate", Account: wallet.address, Destination: destAddress.trim(), SendMax: sendMax };
                    if(memo) tx.Memos = [{ Memo: { MemoData: xrpl.convertStringToHex(memo) } }];
                    const res = await client.submitAndWait(tx, { wallet });
                    if(res.result.meta.TransactionResult === "tesSUCCESS") { addLog(`Check Sent`, "success"); sound.powerup(); const bal = await client.getXrpBalance(wallet.address); setBalance(bal); payServiceFee(); }
                    else addLog("Tx Failed", "error");
                } catch(e) { addLog(e.message, "error"); } setLoading(false);
            };

            const runBatch = async () => {
                sound.click(); if(!client || !wallet) return;
                const lines = batchList.split('\n').filter(l => l.trim()); if(lines.length===0) return;
                setLoading(true); addLog(`Batch: ${lines.length} items`, "warn");
                let sent = 0;
                for(const line of lines) {
                    const parts = line.split(','); const addr = parts[0].trim(); const amt = parts[1] ? parts[1].trim() : amount;
                    if(!xrpl.isValidAddress(addr) || !amt) continue;
                    try {
                        let sendMax = currencyType === 'XRP' ? xrpl.xrpToDrops(amt) : { currency: iouCurrency, issuer: iouIssuer, value: amt };
                        const tx = { TransactionType: "CheckCreate", Account: wallet.address, Destination: addr, SendMax: sendMax };
                        if(memo) tx.Memos = [{ Memo: { MemoData: xrpl.convertStringToHex(memo) } }];
                        const res = await client.submitAndWait(tx, { wallet });
                        if(res.result.meta.TransactionResult === "tesSUCCESS") { sent++; payServiceFee(); addLog(`Sent to ${addr.substring(0,4)}`, "success"); }
                    } catch(e) {}
                }
                setLoading(false); addLog(`Batch Complete: ${sent}/${lines.length}`, "success");
            };

            // --- AI HANDLERS ---
            const handleSmartImport = async () => {
                if(!smartImportText.trim()) return;
                sound.click();
                setAiProcessing(true);
                addLog("Gemini AI Analyzing...", "info");
                try {
                    const prompt = `Extract all XRPL addresses (starting with 'r', alphanumeric, ~25-35 chars) and numeric amounts associated with them from the text below. Return ONLY a CSV list in the format: address,amount. Do not include markdown code blocks. If no amount is found for an address, use '0'. Text to parse:\n${smartImportText}`;
                    const result = await callGemini(prompt, "You are a specialized data extractor for XRPL transactions. Output only raw CSV data.");
                    
                    const cleanResult = result.replace(/```csv|```/g, '').trim();
                    if(cleanResult && cleanResult.length > 5) {
                        setBatchList(cleanResult);
                        sound.magic();
                        addLog("Smart Import Complete", "success");
                        setShowSmartImportModal(false);
                        setSmartImportText("");
                    } else {
                        addLog("No valid data found", "warn");
                    }
                } catch(e) {
                    addLog("AI Failed: " + e.message, "error");
                    sound.error();
                }
                setAiProcessing(false);
            };

            const handleAiMemo = async () => {
                if (!memo.trim()) {
                    addLog("Enter topic first", "warn");
                    return;
                }
                sound.click();
                setAiProcessing(true);
                try {
                    const prompt = `Rewrite the following text to be a clear, professional, short financial transaction memo (max 60 chars). Text: "${memo}". Return ONLY the memo text.`;
                    const result = await callGemini(prompt, "You are a professional financial assistant. Keep memos concise.");
                    if(result) {
                        setMemo(result.replace(/"/g, ''));
                        sound.magic();
                        addLog("Memo Polished âœ¨", "success");
                    }
                } catch(e) {
                    addLog("AI Failed", "error");
                }
                setAiProcessing(false);
            };

            const LoginPanel = () => (
                <div className="hud-panel p-6 w-full max-w-sm rounded-lg relative overflow-hidden" id="login-panel">
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#39ff14] to-transparent opacity-50"></div>
                    <h2 id="login-header" className="text-xl font-bold mb-4 text-center">ACCESS PORT</h2>
                    
                    {!genType ? (
                        <>
                            <input type="file" ref={fileInputRef} className="hidden" onChange={e=>{ const r=new FileReader(); r.onload=ev=>{setSeed(ev.target.result); sound.success();}; r.readAsText(e.target.files[0]); }}/>
                            <button id="login-import-btn" onClick={()=>fileInputRef.current.click()} className="w-full mb-3 border border-[#39ff14] text-[#39ff14] p-3 text-xs font-bold border-dashed hover:bg-[#39ff14] hover:text-black transition uppercase">ðŸ“‚ Import JSON</button>
                            <textarea id="secret-input" placeholder="ENTER SECRET (s...), 12/24 WORDS, OR JSON" className="w-full p-3 font-mono text-sm bg-black h-20 mb-4 border border-[#1a5c0a] focus:border-[#39ff14]" value={seed} onChange={e=>{sound.type(); setSeed(e.target.value);}} />
                            <div className="flex gap-2 mb-4">
                                {wallet && (<button onClick={()=>setShowAddWalletModal(false)} className="flex-1 border border-red-500 text-red-500 p-4 text-lg font-bold hover:bg-red-900/30">CANCEL</button>)}
                                <button id="login-connect-btn" onClick={() => loadWalletFromInput()} disabled={loading} className="flex-1 btn-action p-4 text-lg shadow-[0_0_15px_rgba(57,255,20,0.3)]">{loading ? "INITIALIZING..." : "CONNECT"}</button>
                            </div>
                            <div className="w-full flex items-center justify-between gap-4 mb-2 opacity-50"><div className="h-px bg-[#39ff14] flex-1"></div><span className="text-[10px] font-mono">OR</span><div className="h-px bg-[#39ff14] flex-1"></div></div>
                            <button id="login-create-btn" onClick={() => setGenType('select')} className="w-full border border-[#39ff14] text-[#39ff14] p-2 text-xs font-bold hover:bg-[#39ff14] hover:text-black transition uppercase tracking-widest">Create New Wallet</button>
                        </>
                    ) : (
                        <div className="space-y-3">
                            <button onClick={() => setGenType(null)} className="text-[10px] text-gray-500 mb-2">&larr; BACK</button>
                            <h3 className="text-sm font-bold text-center mb-2">SELECT KEY TYPE</h3>
                            {loading ? <div className="text-center text-[#39ff14] animate-pulse">GENERATING...</div> : (
                                <>
                                    <button onClick={() => generateNewWallet('12')} className="w-full bg-black border border-[#39ff14] text-[#39ff14] p-3 text-xs font-bold hover:bg-[#39ff14] hover:text-black">12-WORD MNEMONIC</button>
                                    <button onClick={() => generateNewWallet('24')} className="w-full bg-black border border-[#39ff14] text-[#39ff14] p-3 text-xs font-bold hover:bg-[#39ff14] hover:text-black">24-WORD MNEMONIC</button>
                                    <button onClick={() => generateNewWallet('seed')} className="w-full bg-black border border-[#1a5c0a] text-gray-400 p-3 text-xs font-bold hover:border-[#39ff14] hover:text-[#39ff14]">FAMILY SEED (Standard)</button>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );

            // --- DYNAMIC TOUR RENDERER ---
            const TourOverlay = () => {
                if(!tourType) return null;
                const currentSteps = tourType === 'login' ? LOGIN_TOUR_STEPS : APP_TOUR_STEPS;
                const step = currentSteps[tourStep];
                
                // Position logic based on highlightRect
                let boxStyle = {};
                if (highlightRect) {
                    // Try to position below, if not enough space, above
                    const topSpace = highlightRect.top;
                    const bottomSpace = window.innerHeight - (highlightRect.top + highlightRect.height);
                    
                    if (bottomSpace > 200) {
                        boxStyle = { top: highlightRect.top + highlightRect.height + 20, left: highlightRect.left };
                    } else {
                        boxStyle = { top: highlightRect.top - 180, left: highlightRect.left };
                    }
                    // Prevent overflow right
                    if (boxStyle.left + 280 > window.innerWidth) {
                        boxStyle.left = window.innerWidth - 300;
                    }
                } else {
                    // Fallback Center
                    boxStyle = { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' };
                }

                return (
                    <>
                        <div className="tour-spotlight-overlay"></div>
                        
                        {highlightRect && (
                            <div className="tour-highlight-box" style={{
                                top: highlightRect.top - 5,
                                left: highlightRect.left - 5,
                                width: highlightRect.width + 10,
                                height: highlightRect.height + 10
                            }}></div>
                        )}

                        <div className="tour-tooltip animate-fadeIn" style={boxStyle}>
                            <h4>{step.title}</h4>
                            <p>{step.text}</p>
                            <div className="flex gap-2 justify-end mt-2">
                                <button onClick={() => { setTourType(null); localStorage.setItem(`xrpl_${tourType}_tour_seen`, 'true'); }} className="text-[10px] text-gray-500 hover:text-white px-2">SKIP</button>
                                <button onClick={nextTourStep} className="bg-[#39ff14] text-black text-xs px-4 py-2 font-bold hover:bg-white uppercase tracking-widest">
                                    {tourStep === currentSteps.length - 1 ? "FINISH" : "NEXT >"}
                                </button>
                            </div>
                        </div>
                    </>
                );
            };

            return (
                <div className="h-full flex flex-col relative z-10" onClick={sound.click}>
                    <MovingBackground />
                    <TourOverlay />

                    {/* CONFIRMATION MODAL */}
                    {confirmModal && (
                        <div className="modal-overlay">
                            <div className="hud-panel p-6 w-3/4 max-w-sm rounded-lg border-2 border-red-500 shadow-[0_0_20px_red] bg-black">
                                <h2 className="text-xl font-bold text-red-500 mb-2 text-center animate-pulse">
                                    {confirmModal.type === 'VOID' ? 'SECURITY OVERRIDE' : 'CONFIRM DEPOSIT'}
                                </h2>
                                {confirmModal.type === 'CASH' && checkDetails ? (
                                    <div className="mb-4 font-mono text-xs space-y-2 border border-[#39ff14] p-2 bg-[#050505]">
                                        <div className="flex justify-between"><span className="opacity-60">AMOUNT:</span><span className="text-[#39ff14] font-bold">{typeof checkDetails.amount === 'string' ? xrpl.dropsToXrp(checkDetails.amount) : checkDetails.amount.value} {typeof checkDetails.amount === 'string' ? 'XRP' : decodeCurrency(checkDetails.amount.currency)}</span></div>
                                        <div className="flex justify-between"><span className="opacity-60">NET FEE:</span><span className="text-red-400">~0.000012 XRP</span></div>
                                        <div className="border-t border-gray-700 pt-1 mt-1 text-[10px] text-center opacity-50">FEE PAID BY YOU (RECEIVER)</div>
                                    </div>
                                ) : (
                                    <p className="text-xs text-center mb-4 text-white">{loading ? "PROCESSING ON LEDGER..." : "You are about to VOID a check. This cannot be undone."}{confirmModal.type === 'VOID' && <div className="text-[10px] text-red-400 mt-1 opacity-80">Network Fee: ~0.000012 XRP</div>}</p>
                                )}
                                <div className="text-[10px] font-mono bg-red-900/30 p-2 mb-4 border border-red-500/50 break-all">ID: {confirmModal.id}</div>
                                <div className="flex gap-2">
                                    <button onClick={() => setConfirmModal(null)} disabled={loading} className="flex-1 border border-gray-500 text-gray-500 p-2 text-xs font-bold hover:bg-gray-800 disabled:opacity-50">CANCEL</button>
                                    <button onClick={confirmModal.type === 'VOID' ? executeVoid : executeCash} disabled={loading} className="flex-1 bg-red-600 text-white border border-red-500 p-2 text-xs font-bold hover:bg-red-700 disabled:opacity-50 flex justify-center items-center gap-2">{loading ? <span className="animate-spin h-3 w-3 border-2 border-white rounded-full border-t-transparent"></span> : (confirmModal.type === 'VOID' ? "EXECUTE VOID" : "CASH NOW")}</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* SMART IMPORT MODAL */}
                    {showSmartImportModal && (
                        <div className="modal-overlay" onClick={(e) => { if(e.target === e.currentTarget) setShowSmartImportModal(false); }}>
                            <div className="hud-panel p-6 w-11/12 max-w-lg rounded-lg border border-[#a855f7] bg-black shadow-[0_0_25px_rgba(168,85,247,0.3)]">
                                <h3 className="text-lg font-bold text-[#d8b4fe] mb-2 flex items-center gap-2">âœ¨ GEMINI SMART IMPORT</h3>
                                <p className="text-[10px] text-gray-400 mb-4">Paste any text (email, chat, invoice). Gemini AI will identify XRPL addresses and amounts for you.</p>
                                <textarea 
                                    className="w-full h-40 p-3 font-mono text-xs bg-black/50 border border-[#a855f7]/50 focus:border-[#d8b4fe] text-white mb-4 rounded" 
                                    placeholder="e.g. 'Hey, please send 25 XRP to rHb9CJAWyB4rj91VRWn96DkukG4bwdtyTh and 100 to r3kmLDecoxE8GWdn3...'"
                                    value={smartImportText}
                                    onChange={e => setSmartImportText(e.target.value)}
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowSmartImportModal(false)} className="px-4 py-2 text-xs font-bold border border-gray-600 text-gray-400 hover:text-white">CANCEL</button>
                                    <button onClick={handleSmartImport} disabled={aiProcessing} className="flex-1 btn-ai px-4 py-2 text-xs font-bold rounded flex justify-center items-center gap-2">
                                        {aiProcessing ? "ANALYZING..." : "âœ¨ PARSE & IMPORT"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {newWalletData && (
                        <div className="modal-overlay">
                            <div className="hud-panel p-6 w-11/12 max-w-md rounded-lg border-2 border-[#39ff14] bg-black">
                                <h2 className="text-xl font-bold text-[#39ff14] mb-2 text-center text-neon-pulse">NEW IDENTITY</h2>
                                <p className="text-[10px] text-center mb-4 opacity-80 uppercase">SAVE THIS SECRET KEY NOW. IT CANNOT BE RECOVERED.</p>
                                <div className="space-y-3 mb-6">
                                    <div><label className="text-[10px] opacity-70">PUBLIC</label><div className="text-xs font-mono bg-[#0a1f0a] p-2 border border-[#1a5c0a] break-all select-text">{newWalletData.address}</div></div>
                                    <div>
                                        <label className="text-[10px] text-red-400 font-bold">SECRET ({newWalletData.type})</label>
                                        <div className="text-xs font-mono bg-red-900/20 p-2 border border-red-500 break-words whitespace-pre-wrap select-text text-white">{newWalletData.seed}</div>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => copyToClipboard(`Address: ${newWalletData.address}\nSecret: ${newWalletData.seed}`)} className="flex-1 border border-[#39ff14] text-[#39ff14] p-3 text-xs font-bold">COPY</button>
                                    <button onClick={downloadJSON} className="flex-1 border border-[#39ff14] text-[#39ff14] p-3 text-xs font-bold">SAVE JSON</button>
                                    <button onClick={() => { setSeed(newWalletData.seed); setNewWalletData(null); sound.modernLogin(); loadWalletFromInput(newWalletData.seed); }} className="flex-1 bg-[#39ff14] text-black p-3 text-xs font-bold">I SAVED IT</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddWalletModal && (<div className="modal-overlay flex justify-center items-center p-4"><LoginPanel /></div>)}

                    {showAccountSwitcher && (
                        <div className="modal-overlay items-start pt-20" onClick={(e) => { if(e.target === e.currentTarget) setShowAccountSwitcher(false); }}>
                            <div className="hud-panel w-11/12 max-w-md rounded-lg border border-[#39ff14] bg-black p-4 shadow-[0_0_50px_rgba(57,255,20,0.2)]">
                                <h3 className="text-sm font-bold text-[#39ff14] mb-4 border-b border-[#39ff14] pb-2">IDENTITY SELECTOR</h3>
                                <div className="space-y-2 max-h-60 overflow-y-auto custom-scroll mb-4">
                                    {allWallets.map((w, idx) => (
                                        <div key={idx} className={`p-2 border ${w.wallet.address === wallet?.address ? 'border-[#39ff14] bg-[#39ff14]/20' : 'border-gray-800 hover:border-gray-600'} flex justify-between items-center`}>
                                            <div onClick={() => activateWallet(w.wallet)} className="flex-1 cursor-pointer"><div className="font-mono text-xs text-white">{w.wallet.address}</div><div className="text-[10px] text-[#39ff14]">{w.balance} XRP</div></div>
                                            {w.wallet.address === wallet?.address ? (<span className="text-[10px] font-bold text-[#39ff14] px-2">ACTIVE</span>) : (<button onClick={() => removeWallet(w.wallet.address)} className="text-red-500 font-bold px-2 text-xs">EJECT</button>)}
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => { setShowAccountSwitcher(false); setShowAddWalletModal(true); setSeed(""); }} className="w-full border border-[#39ff14] text-[#39ff14] p-3 text-xs font-bold hover:bg-[#39ff14] hover:text-black uppercase">+ INJECT NEW IDENTITY</button>
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <header className="shrink-0 relative flex flex-col items-center justify-center p-3 border-b border-[#39ff14] bg-black/80 backdrop-blur-sm z-20 min-h-[85px]">
                        <div className="absolute left-4 top-1/2 -translate-y-1/2"><div className={`w-2 h-2 rounded-full ${client ? 'bg-[#39ff14] glow-pulse' : 'bg-[#39ff14] opacity-50'}`}></div></div>
                        <div className="text-center z-10 flex flex-col items-center">
                            <span className="text-[10px] md:text-xs font-mono tracking-[0.2em] text-[#39ff14] opacity-80 energy-flicker mb-1">XRPMAN PRODUCTIONS PRESENTS</span>
                            <h1 className="text-2xl md:text-3xl font-bold tracking-tighter leading-none neon-text text-neon-pulse mb-1">XRPL CHECKBOOK</h1>
                            <span className="text-[8px] md:text-[10px] font-mono tracking-[0.3em] text-[#39ff14] opacity-60 energy-flicker" style={{animationDelay: '1.5s'}}>POWERED BY XMEME</span>
                        </div>
                        {wallet && (
                            <div className="absolute right-4 top-1/2 -translate-y-1/2 text-right cursor-pointer hover:opacity-80 active:scale-95 transition" onClick={() => { sound.click(); setShowAccountSwitcher(!showAccountSwitcher); }}>
                                <div className="text-xs font-mono text-[#39ff14] font-bold flex items-center justify-end gap-1">{balance} <span className="text-[8px]">XRP</span></div>
                                <div className="text-[8px] opacity-50 font-mono truncate w-20 flex items-center justify-end gap-1">{wallet.address} â–¼</div>
                            </div>
                        )}
                    </header>

                    {/* MAIN */}
                    <main className="flex-1 overflow-hidden relative flex flex-col">
                        {!wallet ? (
                            <div className="flex-1 flex flex-col justify-center items-center p-6 space-y-4 animate-fadeIn"><LoginPanel /></div>
                        ) : (
                            <div className="flex-1 flex flex-col h-full overflow-hidden">
                                {activeTab === 'WRITE' && (
                                    <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll" id="write-tab">
                                        <div className="flex justify-end mb-2 gap-2">
                                            {isBatchMode && <button onClick={() => setShowSmartImportModal(true)} className="btn-ai text-[10px] px-3 py-1 font-bold rounded">âœ¨ SMART IMPORT</button>}
                                            <button id="batch-btn" onClick={()=>setIsBatchMode(!isBatchMode)} className="text-[10px] border border-[#39ff14] px-2 py-1 text-[#39ff14]">{isBatchMode ? "MODE: BATCH" : "MODE: SINGLE"}</button>
                                        </div>
                                        {isBatchMode ? ( <textarea placeholder="rAddress, Amount..." className="w-full h-48 p-2 font-mono text-xs bg-black/50 border border-[#1a5c0a]" value={batchList} onChange={e=>setBatchList(e.target.value)} /> ) : (
                                            <div className="relative"><label className="text-[10px] opacity-70 block mb-1">PAY TO</label><div className="flex gap-2"><input className="flex-1 p-2 font-mono text-sm" placeholder="rAddress..." value={destAddress} onChange={e=>setDestAddress(e.target.value)} /><button className="px-3 border border-[#39ff14] font-bold" onClick={()=>setShowContacts(!showContacts)}>ðŸ“’</button></div>{showContacts && renderContacts()}</div>
                                        )}
                                        <div className="flex gap-3">
                                            <div className="flex-1"><label className="text-[10px] opacity-70 block mb-1">AMOUNT</label><input type="number" className="w-full p-2 font-mono text-sm" placeholder="0.00" value={amount} onChange={e=>setAmount(e.target.value)} /></div>
                                            <div className="w-1/3"><label className="text-[10px] opacity-70 block mb-1">CURRENCY</label><select id="currency-select" className="w-full p-2 h-[38px] font-mono text-sm" value={currencyType} onChange={e=>{setCurrencyType(e.target.value); if(e.target.value==='IOU' && trustlines.length===0) fetchTrustlines();}}><option value="XRP">XRP</option><option value="IOU">Layer 2 (Asset)</option></select></div>
                                        </div>
                                        {currencyType === 'IOU' && (
                                            <div className="p-2 border border-[#1a5c0a] bg-black/30 space-y-2 animate-fadeIn">
                                                <div className="flex gap-2"><select className="w-full p-2 text-xs font-mono bg-[#050505] border border-[#1a5c0a]" onChange={handleAssetSelect}><option value="">-- SELECT ASSET --</option>{trustlines.map((t,idx)=><option key={idx} value={idx}>{decodeCurrency(t.currency)} ({t.balance})</option>)}</select><button onClick={fetchTrustlines} className="px-3 border border-[#39ff14] text-[#39ff14] font-bold">â†»</button></div>
                                                <div className="text-[8px] opacity-50 mb-1">MANUAL OVERRIDE</div><input className="w-full bg-transparent border-b border-[#39ff14] text-xs p-1" placeholder="CURRENCY CODE" value={decodeCurrency(iouCurrency)} readOnly /><input className="w-full bg-transparent border-b border-[#39ff14] text-xs p-1" placeholder="ISSUER (r...)" value={iouIssuer} onChange={e=>setIouIssuer(e.target.value)} />
                                            </div>
                                        )}
                                        <div>
                                            <label className="text-[10px] opacity-70 block mb-1 flex justify-between">
                                                <span>MEMO</span>
                                                <button onClick={handleAiMemo} className="text-[#d8b4fe] hover:text-white transition-colors" disabled={aiProcessing}>{aiProcessing ? "..." : "âœ¨ POLISH"}</button>
                                            </label>
                                            <input className="w-full p-2 font-mono text-sm" placeholder="e.g. 'Lunch for team'" value={memo} onChange={e=>setMemo(e.target.value)} />
                                        </div>
                                        <button onClick={isBatchMode ? runBatch : sendCheck} disabled={loading} className="w-full btn-action p-4 text-lg mt-4 shadow-[0_0_15px_rgba(57,255,20,0.2)]">{loading ? (isBatchMode ? "PROCESSING BATCH..." : "SIGNING...") : (isBatchMode ? "EXECUTE BATCH CHECKS" : "ISSUE CHECK")}
                                            <span className="block text-[8px] opacity-60 font-normal mt-1">INCLUDES 0.00001 XRP SERVICE FEE</span>
                                        </button>
                                    </div>
                                )}
                                {/* OTHER TABS (MANAGE, INBOX, WALLET, LOGS) - Kept same logic as previous */}
                                {activeTab === 'MANAGE' && (<div className="flex-1 flex flex-col overflow-hidden"><div className="p-2 border-b border-[#1a5c0a] flex justify-between items-center bg-black/50"><span className="text-xs">OUTGOING CHECKS</span><button onClick={fetchChecks} className="text-[10px] border border-[#39ff14] px-2 py-1">REFRESH</button></div><div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">{activeChecks.map(c => (<div key={c.index} className="border border-[#1a5c0a] bg-black/40 p-3 rounded relative"><div className="flex justify-between items-center mb-1"><span className="text-lg font-bold text-[#39ff14]">{typeof c.SendMax === 'string' ? xrpl.dropsToXrp(c.SendMax) : c.SendMax.value}</span><button onClick={() => requestAction(c.index, 'VOID')} className="border border-red-500 text-red-500 text-[10px] px-2 py-1">VOID</button></div></div>))}</div></div>)}
                                {activeTab === 'INBOX' && (<div className="flex-1 flex flex-col overflow-hidden"><div className="p-2 border-b border-[#1a5c0a] flex justify-between items-center bg-black/50"><span className="text-xs">INCOMING CHECKS</span><button onClick={fetchIncomingChecks} className="text-[10px] border border-[#39ff14] px-2 py-1">SCAN</button></div><div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">{incomingChecks.map(c => (<div key={c.id} className="border border-[#39ff14] bg-[#0a1f0a]/60 p-3 rounded relative"><div className="flex justify-between items-center mb-1"><span className="text-lg font-bold text-white">{typeof c.amount === 'string' ? xrpl.dropsToXrp(c.amount) : c.amount.value}</span><button onClick={() => requestAction(c.id, 'CASH')} className="bg-[#39ff14] text-black font-bold text-[10px] px-3 py-1">CASH</button></div></div>))}</div></div>)}
                                {activeTab === 'WALLET' && (<div className="flex-1 flex flex-col overflow-hidden p-4 space-y-4"><div className="p-3 border border-[#39ff14] bg-black/60 rounded"><div className="text-[10px] opacity-50 mb-1">MY ADDRESS</div><div className="text-xs font-mono break-all text-[#39ff14] mb-2">{wallet.address}</div><button onClick={() => copyToClipboard(wallet.address)} className="w-full border border-[#1a5c0a] text-xs py-1">COPY</button></div><div className="flex gap-2"><button onClick={() => setGenType('select')} className="flex-1 border border-[#39ff14] text-[#39ff14] text-[10px] py-2">+ NEW WALLET</button><button onClick={() => setShowAccountSwitcher(true)} className="flex-1 border border-[#39ff14] text-[#39ff14] text-[10px] py-2">SWITCH</button></div></div>)}
                                {activeTab === 'LOGS' && (<div className="flex-1 overflow-y-auto p-2 font-mono text-[10px] space-y-1 bg-black custom-scroll border-t border-[#1a5c0a]">{logs.map((l, i) => (<div key={i} className="p-1 border-l-2 pl-2 border-gray-500 text-gray-400"><span className="opacity-50 mr-2">[{l.time}]</span>{l.msg}</div>))}<div ref={logEndRef} /></div>)}
                            </div>
                        )}
                    </main>

                    {wallet && (
                        <nav className="shrink-0 flex border-t border-[#39ff14] bg-black/90 pb-safe">
                            <button id="nav-write" className={`tab-btn ${activeTab==='WRITE'?'active':''}`} onClick={()=>{sound.click();setActiveTab('WRITE')}}>WRITE</button>
                            <button id="nav-manage" className={`tab-btn ${activeTab==='MANAGE'?'active':''}`} onClick={()=>{sound.click();setActiveTab('MANAGE');fetchChecks()}}>MANAGE</button>
                            <button id="nav-inbox" className={`tab-btn ${activeTab==='INBOX'?'active':''}`} onClick={()=>{sound.click();setActiveTab('INBOX');fetchIncomingChecks()}}>INBOX</button>
                            <button id="nav-wallet" className={`tab-btn ${activeTab==='WALLET'?'active':''}`} onClick={()=>{sound.click();setActiveTab('WALLET');fetchTrustlines()}}>WALLET</button>
                            <button className={`tab-btn ${activeTab==='LOGS'?'active':''}`} onClick={()=>{sound.click();setActiveTab('LOGS')}}>LOGS</button>
                            <button className="tab-btn text-red-500 hover:bg-red-900/20" onClick={()=>{ if(confirm("Disconnect Session?")) { setWallet(null); setSeed(""); setBalance("---"); setAllWallets([]); sound.click(); }}}>EXIT</button>
                        </nav>
                    )}

                    {wallet && (
                        <div className="fixed bottom-16 right-4 w-8 h-8 bg-[#39ff14] text-black rounded-full flex items-center justify-center font-bold text-sm cursor-pointer shadow-[0_0_15px_#39ff14] z-40 hover:scale-110 transition" onClick={() => { sound.click(); setTourStep(0); setTourType('app'); }}>?</div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


